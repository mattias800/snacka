name: Build Client

on:
  push:
    branches: [master]
    paths:
      - 'src/Snacka.Client/**'
      - 'src/Snacka.Shared/**'
      - 'src/Snacka.WebRTC/**'
      - 'src/SnackaCapture/**'
      - 'src/SnackaCaptureWindows/**'
      - 'src/SnackaMetalRenderer/**'
      - 'installers/**'
      - '.github/workflows/build-client.yml'
    tags:
      - 'v*'  # Tags always trigger, paths filter only applies to branches
  pull_request:
    branches: [master]
    paths:
      - 'src/Snacka.Client/**'
      - 'src/Snacka.Shared/**'
      - 'src/Snacka.WebRTC/**'
      - 'src/SnackaCapture/**'
      - 'src/SnackaMetalRenderer/**'
      - 'installers/**'
      - '.github/workflows/build-client.yml'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release (use for testing release process)'
        required: false
        default: false
        type: boolean

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  # Determine version from tag or generate dev version
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_release: ${{ steps.version.outputs.is_release }}
    steps:
      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "version=0.0.0-dev.${{ github.run_number }}" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # macOS Build (Apple Silicon)
  # ============================================
  build-macos:
    needs: version
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for MinVer

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install Homebrew dependencies
        run: |
          brew install ffmpeg@6 libvpx
          echo "$(brew --prefix ffmpeg@6)/lib" >> $GITHUB_PATH

      - name: Build SnackaCapture
        run: |
          cd src/SnackaCapture
          swift build -c release

      - name: Build SnackaMetalRenderer
        run: |
          cd src/SnackaMetalRenderer
          swift build -c release

      - name: Publish Snacka.Client
        run: |
          dotnet publish src/Snacka.Client -c Release -r osx-arm64 \
            --self-contained \
            -p:Version=${{ needs.version.outputs.version }} \
            -o publish

      - name: Copy native binaries
        run: |
          cp src/SnackaCapture/.build/arm64-apple-macosx/release/SnackaCapture publish/
          cp src/SnackaMetalRenderer/.build/arm64-apple-macosx/release/libSnackaMetalRenderer.dylib publish/

      - name: Create .app bundle
        run: |
          chmod +x installers/macos/*.sh
          ./installers/macos/create-app-bundle.sh \
            ./publish \
            ./output \
            ${{ needs.version.outputs.version }} \
            arm64

      - name: Create DMG
        if: needs.version.outputs.is_release == 'true' || github.event.inputs.create_release == 'true'
        run: |
          ./installers/macos/create-dmg.sh \
            ./output/Snacka.app \
            ./output/Snacka-${{ needs.version.outputs.version }}-macOS.dmg \
            "Snacka"

      - name: Upload app bundle
        uses: actions/upload-artifact@v4
        with:
          name: Snacka-macOS-app
          path: output/Snacka.app

      - name: Upload DMG
        if: needs.version.outputs.is_release == 'true' || github.event.inputs.create_release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Snacka-macOS-dmg
          path: output/*.dmg

  # ============================================
  # Windows Build
  # ============================================
  build-windows:
    needs: version
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for MinVer

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build SnackaCaptureWindows
        run: |
          cd src/SnackaCaptureWindows
          cmake -B build -G "Visual Studio 17 2022" -A x64
          cmake --build build --config Release

      - name: Publish Snacka.Client
        run: |
          dotnet publish src/Snacka.Client -c Release -r win-x64 `
            --self-contained `
            -p:Version=${{ needs.version.outputs.version }} `
            -o publish

      - name: Copy SnackaCaptureWindows
        run: |
          Copy-Item "src/SnackaCaptureWindows/build/bin/Release/SnackaCaptureWindows.exe" "publish/" -ErrorAction SilentlyContinue
          if (-not (Test-Path "publish/SnackaCaptureWindows.exe")) {
            Copy-Item "src/SnackaCaptureWindows/build/bin/SnackaCaptureWindows.exe" "publish/" -ErrorAction SilentlyContinue
          }

      - name: Upload portable build
        uses: actions/upload-artifact@v4
        with:
          name: Snacka-Windows-x64-portable
          path: publish/

      - name: Install Inno Setup
        if: needs.version.outputs.is_release == 'true' || github.event.inputs.create_release == 'true'
        run: |
          choco install innosetup -y

      - name: Create installer
        if: needs.version.outputs.is_release == 'true' || github.event.inputs.create_release == 'true'
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            installers/windows/Snacka.iss `
            /DVersion=${{ needs.version.outputs.version }} `
            /DSourceDir=${{ github.workspace }}\publish `
            /DOutputDir=${{ github.workspace }}\output

      - name: Upload installer
        if: needs.version.outputs.is_release == 'true' || github.event.inputs.create_release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Snacka-Windows-x64-installer
          path: output/*.exe

  # ============================================
  # Linux Build
  # ============================================
  build-linux:
    needs: version
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for MinVer

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ffmpeg \
            libvpx-dev \
            libvlc-dev \
            vlc \
            x11-xserver-utils \
            wmctrl \
            libfuse2 \
            imagemagick

      - name: Publish Snacka.Client
        run: |
          dotnet publish src/Snacka.Client -c Release -r linux-x64 \
            --self-contained \
            -p:Version=${{ needs.version.outputs.version }} \
            -o publish

      - name: Upload portable build
        uses: actions/upload-artifact@v4
        with:
          name: Snacka-Linux-x64-portable
          path: publish/

      - name: Create AppImage
        if: needs.version.outputs.is_release == 'true' || github.event.inputs.create_release == 'true'
        run: |
          chmod +x installers/linux/*.sh installers/linux/AppRun
          mkdir -p output
          ./installers/linux/create-appimage.sh \
            ./publish \
            ./output \
            ${{ needs.version.outputs.version }}

      - name: Upload AppImage
        if: needs.version.outputs.is_release == 'true' || github.event.inputs.create_release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Snacka-Linux-x64-AppImage
          path: output/*.AppImage

  # ============================================
  # Create GitHub Release
  # ============================================
  release:
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
    needs: [version, build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # macOS DMG
          cp artifacts/Snacka-macOS-dmg/*.dmg release-assets/ 2>/dev/null || true

          # Windows installer
          cp artifacts/Snacka-Windows-x64-installer/*.exe release-assets/ 2>/dev/null || true

          # Linux AppImage
          cp artifacts/Snacka-Linux-x64-AppImage/*.AppImage release-assets/ 2>/dev/null || true

          # Create portable ZIPs
          cd artifacts
          if [ -d "Snacka-Windows-x64-portable" ]; then
            zip -r ../release-assets/Snacka-${{ needs.version.outputs.version }}-Windows-x64-portable.zip Snacka-Windows-x64-portable
          fi
          if [ -d "Snacka-Linux-x64-portable" ]; then
            tar -czvf ../release-assets/Snacka-${{ needs.version.outputs.version }}-Linux-x64-portable.tar.gz Snacka-Linux-x64-portable
          fi
          if [ -d "Snacka-macOS-app" ]; then
            zip -r ../release-assets/Snacka-${{ needs.version.outputs.version }}-macOS-app.zip Snacka-macOS-app
          fi

          cd ..
          ls -la release-assets/

      - name: Generate release notes
        id: release_notes
        run: |
          cat << 'EOF' > release-notes.md
          ## Snacka ${{ needs.version.outputs.version }}

          ### Downloads

          | Platform | Installer | Portable |
          |----------|-----------|----------|
          | **macOS** | [DMG](../../releases/download/v${{ needs.version.outputs.version }}/Snacka-${{ needs.version.outputs.version }}-macOS.dmg) | [App Bundle](../../releases/download/v${{ needs.version.outputs.version }}/Snacka-${{ needs.version.outputs.version }}-macOS-app.zip) |
          | **Windows** | [Installer](../../releases/download/v${{ needs.version.outputs.version }}/Snacka-${{ needs.version.outputs.version }}-x64-Setup.exe) | [Portable ZIP](../../releases/download/v${{ needs.version.outputs.version }}/Snacka-${{ needs.version.outputs.version }}-Windows-x64-portable.zip) |
          | **Linux** | [AppImage](../../releases/download/v${{ needs.version.outputs.version }}/Snacka-${{ needs.version.outputs.version }}-x86_64.AppImage) | [Portable tar.gz](../../releases/download/v${{ needs.version.outputs.version }}/Snacka-${{ needs.version.outputs.version }}-Linux-x64-portable.tar.gz) |

          ### Requirements

          - **macOS**: macOS 11.0 (Big Sur) or later, Apple Silicon. [VLC](https://www.videolan.org/vlc/) recommended for audio playback.
          - **Windows**: Windows 10 or later. [VLC](https://www.videolan.org/vlc/) recommended for audio playback.
          - **Linux**: Most modern distributions. Requires: `ffmpeg`, `vlc`, `libvlc-dev`

          ### macOS Users

          The app is not code-signed. On first launch:
          1. Right-click the app and select "Open"
          2. Click "Open" in the security dialog

          ### Linux Users

          Make the AppImage executable before running:
          ```bash
          chmod +x Snacka-*.AppImage
          ./Snacka-*.AppImage
          ```

          ---
          *Full changelog: https://github.com/${{ github.repository }}/compare/...${{ github.ref_name }}*
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Snacka ${{ needs.version.outputs.version }}
          body_path: release-notes.md
          draft: ${{ github.event.inputs.create_release == 'true' }}
          prerelease: ${{ contains(needs.version.outputs.version, '-') }}
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
