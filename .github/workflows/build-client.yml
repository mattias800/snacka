name: Build Client

on:
  push:
    branches: [master]
    paths:
      - 'src/Snacka.Client/**'
      - 'src/Snacka.Shared/**'
      - 'src/SnackaCapture/**'
      - 'src/SnackaMetalRenderer/**'
      - '.github/workflows/build-client.yml'
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  build-macos-arm64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install Homebrew dependencies
        run: |
          brew install ffmpeg@6 libvpx
          echo "$(brew --prefix ffmpeg@6)/lib" >> $GITHUB_PATH

      - name: Build SnackaCapture
        run: |
          cd src/SnackaCapture
          swift build -c release

      - name: Build SnackaMetalRenderer
        run: |
          cd src/SnackaMetalRenderer
          swift build -c release

      - name: Publish Snacka.Client
        run: |
          dotnet publish src/Snacka.Client -c Release -r osx-arm64 \
            --self-contained -o publish

      - name: Copy native binaries
        run: |
          cp src/SnackaCapture/.build/arm64-apple-macosx/release/SnackaCapture publish/
          cp src/SnackaMetalRenderer/.build/arm64-apple-macosx/release/libSnackaMetalRenderer.dylib publish/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Snacka-macOS-arm64
          path: publish/

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Publish Snacka.Client
        run: |
          dotnet publish src/Snacka.Client -c Release -r win-x64 --self-contained -o publish

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Snacka-Windows-x64
          path: publish/

  build-linux:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ffmpeg \
            libvpx-dev \
            libvlc-dev \
            vlc \
            x11-xserver-utils \
            wmctrl

      - name: Publish Snacka.Client
        run: |
          dotnet publish src/Snacka.Client -c Release -r linux-x64 \
            --self-contained -o publish

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Snacka-Linux-x64
          path: publish/
