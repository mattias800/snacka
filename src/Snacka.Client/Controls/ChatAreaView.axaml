<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:controls="using:Snacka.Client.Controls"
             xmlns:conv="using:Snacka.Client.Converters"
             xmlns:services="using:Snacka.Client.Services"
             xmlns:ui="using:FluentAvalonia.UI.Controls"
             mc:Ignorable="d"
             x:Class="Snacka.Client.Controls.ChatAreaView"
             x:DataType="controls:ChatAreaView">

    <Border Background="{StaticResource Content2Brush}">
        <DockPanel>
            <!-- Channel Header -->
            <Border DockPanel.Dock="Top" Classes="panel-header">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="#"
                               Foreground="{StaticResource Foreground3Brush}"
                               FontSize="22"
                               VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding ChannelName, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}, FallbackValue='general'}"
                               Classes="heading-3"
                               VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding ChannelTopic, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                               Classes="text-muted"
                               FontSize="13"
                               VerticalAlignment="Center"
                               Margin="8,0,0,0"
                               IsVisible="{Binding ChannelTopic, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                    <!-- Pinned Messages Button -->
                    <Button Classes="btn-icon"
                            Command="{Binding ShowPinnedMessagesCommand, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                            ToolTip.Tip="Pinned Messages"
                            Margin="8,0,0,0"
                            VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <ui:SymbolIcon Symbol="Pin" FontSize="14" Foreground="#b5bac1"/>
                            <TextBlock Text="{Binding PinnedCount, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                                       Foreground="#80848e"
                                       FontSize="12"
                                       VerticalAlignment="Center"
                                       IsVisible="{Binding PinnedCount, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}, Converter={x:Static conv:IntGreaterThanZeroConverter.Instance}}"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>

            <!-- Message Input -->
            <Border DockPanel.Dock="Bottom" Classes="panel-footer">
                <StackPanel Spacing="8">
                    <!-- Formatting Toolbar -->
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <Button Classes="btn-ghost"
                                Padding="8,4"
                                ToolTip.Tip="Bold (wrap with **)"
                                Click="OnBoldClick">
                            <TextBlock Text="B" Foreground="#b5bac1" FontWeight="Bold" FontSize="14"/>
                        </Button>
                        <Button Classes="btn-ghost"
                                Padding="8,4"
                                ToolTip.Tip="Italic (wrap with *)"
                                Click="OnItalicClick">
                            <TextBlock Text="I" Foreground="#b5bac1" FontStyle="Italic" FontSize="14"/>
                        </Button>
                        <Button Classes="btn-ghost"
                                Padding="8,4"
                                ToolTip.Tip="Code (wrap with `)"
                                Click="OnCodeClick">
                            <TextBlock Text="&lt;/&gt;" Foreground="#b5bac1" FontFamily="Consolas,monospace" FontSize="12"/>
                        </Button>
                        <Border Width="1" Background="{StaticResource BorderBrush}" Margin="4,2"/>
                        <TextBlock Text="Markdown supported"
                                   Classes="text-caption"
                                   VerticalAlignment="Center"
                                   Margin="4,0,0,0"/>
                    </StackPanel>

                    <!-- Reply Preview Banner -->
                    <Border Background="{StaticResource Content1Brush}"
                            CornerRadius="12"
                            Padding="12,8"
                            Margin="0,0,0,8"
                            IsVisible="{Binding IsReplying, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                <ui:SymbolIcon Symbol="MailReply" Foreground="{StaticResource PrimaryBrush}" FontSize="14" VerticalAlignment="Center"/>
                                <TextBlock Text="Replying to" Classes="text-muted" FontSize="13" VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding ReplyingToAuthor, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                                           Foreground="{StaticResource PrimaryBrush}"
                                           FontSize="13"
                                           FontWeight="SemiBold"
                                           VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding ReplyingToContent, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                                           Classes="text-muted"
                                           FontSize="13"
                                           TextTrimming="CharacterEllipsis"
                                           MaxWidth="350"
                                           VerticalAlignment="Center"/>
                            </StackPanel>
                            <Button Grid.Column="1"
                                    Classes="btn-icon"
                                    Command="{Binding CancelReplyCommand, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                                    ToolTip.Tip="Cancel Reply">
                                <ui:SymbolIcon Symbol="Dismiss" Foreground="#80848e" FontSize="14"/>
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Typing Indicator -->
                    <TextBlock Text="{Binding TypingIndicatorText, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                               IsVisible="{Binding IsAnyoneTyping, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                               Classes="text-muted"
                               FontSize="12"
                               FontStyle="Italic"
                               Margin="0,0,0,4"/>

                    <!-- Pending Attachments Preview -->
                    <Border Background="{StaticResource Content1Brush}"
                            CornerRadius="12"
                            Padding="12"
                            Margin="0,0,0,8"
                            IsVisible="{Binding HasPendingAttachments, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}">
                        <DockPanel>
                            <TextBlock DockPanel.Dock="Top"
                                       Text="ATTACHMENTS"
                                       Classes="text-caption"
                                       Margin="0,0,0,8"/>
                            <ItemsControl x:Name="PendingAttachmentsList"
                                          ItemsSource="{Binding PendingAttachments, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{StaticResource Content3Brush}"
                                                CornerRadius="10"
                                                Padding="10,6"
                                                Margin="0,0,8,4">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="{Binding FileName}"
                                                           Classes="text-body"
                                                           MaxWidth="200"
                                                           TextTrimming="CharacterEllipsis"
                                                           VerticalAlignment="Center"/>
                                                <TextBlock Text="{Binding FormattedSize}"
                                                           Classes="text-muted"
                                                           FontSize="11"
                                                           VerticalAlignment="Center"/>
                                                <Button Classes="btn-icon"
                                                        Padding="4"
                                                        MinWidth="20"
                                                        MinHeight="20"
                                                        ToolTip.Tip="Remove"
                                                        Click="OnRemovePendingAttachment"
                                                        Tag="{Binding}">
                                                    <ui:SymbolIcon Symbol="Dismiss" Foreground="#80848e" FontSize="10"/>
                                                </Button>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </DockPanel>
                    </Border>

                    <!-- Mention Autocomplete Popup -->
                    <Border Background="{StaticResource GlassBrush}"
                            CornerRadius="16"
                            Padding="8"
                            Margin="0,0,0,8"
                            BoxShadow="{StaticResource ShadowLg}"
                            IsVisible="{Binding IsMentionPopupOpen, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}">
                        <ItemsControl x:Name="MentionSuggestionsList"
                                      ItemsSource="{Binding MentionSuggestions, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="services:CommunityMemberResponse">
                                    <Border x:Name="MentionItemBorder"
                                            Classes="member-item"
                                            Padding="10,8"
                                            CornerRadius="6"
                                            Cursor="Hand"
                                            PointerPressed="MentionSuggestion_PointerPressed">
                                        <Border.Background>
                                            <MultiBinding Converter="{x:Static conv:MentionSelectedBackgroundConverter.Instance}">
                                                <Binding />
                                                <Binding Path="MentionSuggestions" RelativeSource="{RelativeSource AncestorType=controls:ChatAreaView}" />
                                                <Binding Path="SelectedMentionIndex" RelativeSource="{RelativeSource AncestorType=controls:ChatAreaView}" />
                                            </MultiBinding>
                                        </Border.Background>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>

                                            <!-- Avatar -->
                                            <Border Grid.Column="0"
                                                    Width="32" Height="32"
                                                    CornerRadius="16"
                                                    Background="{StaticResource PrimaryGradient}"
                                                    Margin="0,0,10,0">
                                                <TextBlock Text="{Binding Username, Converter={x:Static conv:FirstCharConverter.Instance}}"
                                                           Foreground="White"
                                                           FontSize="13"
                                                           FontWeight="Bold"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                            </Border>

                                            <!-- Username -->
                                            <TextBlock Grid.Column="1"
                                                       Text="{Binding Username}"
                                                       Classes="text-body"
                                                       VerticalAlignment="Center"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Border>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Attach Button -->
                        <Button Grid.Column="0"
                                Classes="btn-icon"
                                Padding="12,10"
                                Margin="0,0,4,0"
                                ToolTip.Tip="Attach files"
                                Click="OnAttachButtonClick">
                            <ui:SymbolIcon Symbol="Attach" FontSize="18" Foreground="#b5bac1"/>
                        </Button>

                        <!-- GIF Button -->
                        <Button x:Name="GifButton"
                                Grid.Column="1"
                                Classes="btn-icon"
                                Padding="8,10"
                                Margin="0,0,4,0"
                                ToolTip.Tip="Send a GIF"
                                IsVisible="{Binding IsGifsEnabled, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                                Click="OnGifButtonClick">
                            <TextBlock Text="GIF" FontSize="11" FontWeight="Bold" Foreground="#b5bac1"/>
                        </Button>

                        <TextBox x:Name="MessageInputBox"
                                 Grid.Column="2"
                                 Classes="input-chat"
                                 Text="{Binding MessageInput, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}, Mode=TwoWay}"
                                 Watermark="{Binding ChannelName, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}, StringFormat='Message #{0}'}"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 MaxHeight="200"
                                 DragDrop.AllowDrop="True"/>

                        <Button Grid.Column="3"
                                Classes="btn-primary"
                                Command="{Binding SendMessageCommand, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                                Margin="8,0,0,0">
                            <Panel>
                                <TextBlock Text="Send" IsVisible="{Binding IsLoading, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}, Converter={x:Static BoolConverters.Not}}"/>
                                <TextBlock Text="..." IsVisible="{Binding IsLoading, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"/>
                            </Panel>
                        </Button>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Messages List -->
            <ScrollViewer x:Name="MessagesScrollViewer" Margin="0,8" HorizontalScrollBarVisibility="Disabled">
                <ItemsControl x:Name="MessagesList"
                              ItemsSource="{Binding Messages, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                              Margin="16,0"
                              HorizontalAlignment="Stretch"
                              Width="{Binding $parent[ScrollViewer].Viewport.Width}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="services:MessageResponse">
                            <controls:MessageItemView
                                Message="{Binding}"
                                AuthorUsername="{Binding AuthorUsername}"
                                MessageContent="{Binding Content}"
                                CreatedAt="{Binding CreatedAt}"
                                IsEdited="{Binding IsEdited}"
                                ReplyTo="{Binding ReplyTo}"
                                Reactions="{Binding Reactions}"
                                Attachments="{Binding Attachments}"
                                IsPinned="{Binding IsPinned}"
                                ReplyCount="{Binding ReplyCount}"
                                BaseUrl="{Binding BaseUrl, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                                TogglePinCommand="{Binding TogglePinCommand, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                                ReplyToMessageCommand="{Binding ReplyToMessageCommand, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                                StartEditMessageCommand="{Binding StartEditMessageCommand, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                                DeleteMessageCommand="{Binding DeleteMessageCommand, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                                ShowThreadIndicator="True"
                                ShowStartThreadButton="True"
                                ShowPinButton="True"
                                ShowReplyButton="True"
                                ShowReactions="True"
                                ShowAttachments="True"
                                AddReactionRequested="OnMessageAddReactionRequested"
                                StartThreadRequested="OnMessageStartThreadRequested"
                                ViewThreadRequested="OnMessageViewThreadRequested"
                                ReactionToggleRequested="OnMessageReactionToggleRequested"
                                ImageClicked="OnAttachmentImageClicked">
                                <controls:MessageItemView.ShowDateSeparator>
                                    <MultiBinding Converter="{x:Static conv:ShowDateSeparatorConverter.Instance}">
                                        <Binding />
                                        <Binding Path="Messages" RelativeSource="{RelativeSource AncestorType=controls:ChatAreaView}" />
                                    </MultiBinding>
                                </controls:MessageItemView.ShowDateSeparator>
                            </controls:MessageItemView>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- Message Edit Overlay -->
            <Border Background="{StaticResource GlassBrush}"
                    DockPanel.Dock="Bottom"
                    Padding="16"
                    CornerRadius="16"
                    Margin="16,0,16,16"
                    IsVisible="{Binding IsEditing, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}">
                <StackPanel Spacing="8">
                    <TextBlock Text="EDITING MESSAGE"
                               Classes="text-caption"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Grid.Column="0"
                                 x:Name="EditMessageInputBox"
                                 Classes="input-chat"
                                 Text="{Binding EditingMessageContent, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}, Mode=TwoWay}"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 MaxHeight="200"/>
                        <Button Grid.Column="1"
                                Classes="btn-secondary"
                                Command="{Binding CancelEditMessageCommand, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                                Content="Cancel"
                                Margin="8,0,0,0"/>
                        <Button Grid.Column="2"
                                Classes="btn-primary"
                                Command="{Binding SaveMessageEditCommand, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"
                                Margin="8,0,0,0">
                            <Panel>
                                <TextBlock Text="Save" IsVisible="{Binding IsLoading, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}, Converter={x:Static BoolConverters.Not}}"/>
                                <TextBlock Text="..." IsVisible="{Binding IsLoading, RelativeSource={RelativeSource AncestorType=controls:ChatAreaView}}"/>
                            </Panel>
                        </Button>
                    </Grid>
                </StackPanel>
            </Border>
        </DockPanel>
    </Border>
</UserControl>
