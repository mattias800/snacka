<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:conv="using:Snacka.Client.Converters"
             xmlns:controls="using:Snacka.Client.Controls"
             xmlns:ui="using:FluentAvalonia.UI.Controls"
             mc:Ignorable="d"
             x:Class="Snacka.Client.Controls.MessageItemView"
             x:DataType="controls:MessageItemView"
             HorizontalAlignment="Stretch">

    <StackPanel HorizontalAlignment="Stretch">
        <!-- Date separator (optional) -->
        <Border Margin="0,16,0,8" Padding="0"
                IsVisible="{Binding ShowDateSeparator, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}">
            <Grid>
                <Separator Background="{StaticResource BorderBrush}" Margin="0,8"/>
                <Border Background="{StaticResource Content2Brush}" HorizontalAlignment="Center" Padding="12,4" CornerRadius="12">
                    <TextBlock Text="{Binding CreatedAt, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}, Converter={x:Static conv:DateSeparatorTextConverter.Instance}}"
                               Classes="text-caption"/>
                </Border>
            </Grid>
        </Border>

        <Border Margin="0" Padding="8,12" x:Name="MessageBorder" Classes="message-row" HorizontalAlignment="Stretch">
            <!-- Use Panel to allow action buttons to overlay content -->
            <Panel>
                <Grid HorizontalAlignment="Stretch">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Avatar -->
                    <Border Grid.Column="0"
                        Width="40" Height="40"
                        CornerRadius="20"
                        Background="{StaticResource PrimaryGradient}"
                        VerticalAlignment="Top"
                        Margin="0,0,12,0">
                    <TextBlock Text="{Binding AuthorUsername, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}, Converter={x:Static conv:FirstCharConverter.Instance}}"
                               Foreground="White"
                               FontSize="16"
                               FontWeight="Bold"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"/>
                </Border>

                <!-- Message Content -->
                <StackPanel Grid.Column="1">
                    <!-- Reply Preview (if this message is a reply) -->
                    <Border Background="{StaticResource Content1Brush}"
                            CornerRadius="10"
                            Padding="10,6"
                            Margin="0,0,0,6"
                            BorderBrush="{StaticResource PrimaryBrush}"
                            BorderThickness="2,0,0,0"
                            IsVisible="{Binding ReplyTo, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <ui:SymbolIcon Symbol="MailReply" Foreground="{StaticResource PrimaryBrush}" FontSize="12" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding ReplyTo.AuthorUsername, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                       Foreground="{StaticResource PrimaryBrush}"
                                       FontSize="12"
                                       FontWeight="SemiBold"
                                       VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding ReplyTo.Content, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                       Classes="text-muted"
                                       FontSize="12"
                                       TextTrimming="CharacterEllipsis"
                                       MaxWidth="400"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding AuthorUsername, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                   Classes="heading-3"
                                   FontSize="15"/>
                        <TextBlock Text="{Binding CreatedAt, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}, Converter={x:Static conv:RelativeTimestampConverter.Instance}}"
                                   ToolTip.Tip="{Binding CreatedAt, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}, Converter={x:Static conv:FullTimestampConverter.Instance}}"
                                   Classes="text-muted"
                                   FontSize="12"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="(edited)"
                                   Classes="text-muted"
                                   FontSize="11"
                                   VerticalAlignment="Center"
                                   IsVisible="{Binding IsEdited, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"/>
                    </StackPanel>

                    <controls:MessageContentBlock Content="{Binding MessageContent, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                                  FontSize="15"
                                                  Margin="0,4,0,0"/>

                    <!-- Attachments Display -->
                    <ItemsControl x:Name="AttachmentsControl"
                                  ItemsSource="{Binding Attachments, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                  Margin="0,8,0,0">
                        <ItemsControl.IsVisible>
                            <MultiBinding Converter="{x:Static BoolConverters.And}">
                                <Binding Path="ShowAttachments" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}"/>
                                <Binding Path="Attachments" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}" Converter="{x:Static ObjectConverters.IsNotNull}"/>
                            </MultiBinding>
                        </ItemsControl.IsVisible>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <controls:AttachmentPreview Attachment="{Binding}"
                                                           BaseUrl="{Binding BaseUrl, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                                           AccessToken="{Binding AccessToken, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                                           ImageClicked="AttachmentPreview_ImageClicked"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Reactions Display -->
                    <ItemsControl ItemsSource="{Binding Reactions, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                  Margin="0,8,0,0">
                        <ItemsControl.IsVisible>
                            <MultiBinding Converter="{x:Static BoolConverters.And}">
                                <Binding Path="ShowReactions" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}"/>
                                <Binding Path="Reactions" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}" Converter="{x:Static ObjectConverters.IsNotNull}"/>
                            </MultiBinding>
                        </ItemsControl.IsVisible>
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="6"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Classes="reaction-chip"
                                        Padding="6,4"
                                        CornerRadius="10"
                                        Cursor="Hand"
                                        Tag="{Binding}"
                                        PointerPressed="ReactionChip_PointerPressed">
                                    <Border.Background>
                                        <SolidColorBrush Color="{Binding HasReacted, Converter={x:Static conv:ReactionBackgroundConverter.Instance}}"/>
                                    </Border.Background>
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <TextBlock Text="{Binding Emoji}" FontSize="14"/>
                                        <TextBlock Text="{Binding Count}" Classes="text-body" FontSize="12" VerticalAlignment="Center"/>
                                    </StackPanel>
                                    <ToolTip.Tip>
                                        <ItemsControl ItemsSource="{Binding Users}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Username}" Foreground="White"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ToolTip.Tip>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Thread Indicator (only when there are replies and ShowThreadIndicator is true) -->
                    <Border Margin="0,8,0,0"
                            Padding="12,8"
                            Classes="thread-indicator"
                            CornerRadius="10"
                            Cursor="Hand"
                            HorizontalAlignment="Left"
                            Tag="{Binding Message, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                            PointerPressed="ThreadIndicator_PointerPressed">
                        <Border.IsVisible>
                            <MultiBinding Converter="{x:Static BoolConverters.And}">
                                <Binding Path="ShowThreadIndicator" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}"/>
                                <Binding Path="ReplyCount" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}" Converter="{x:Static conv:IntGreaterThanZeroConverter.Instance}"/>
                            </MultiBinding>
                        </Border.IsVisible>
                        <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                            <TextBlock Foreground="{StaticResource PrimaryBrush}" FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center">
                                <TextBlock.Text>
                                    <MultiBinding StringFormat="{}{0} {1}">
                                        <Binding Path="ReplyCount" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}"/>
                                        <Binding Path="ReplyCount" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}" Converter="{x:Static conv:PluralizeConverter.Instance}" ConverterParameter="reply|replies"/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                            <TextBlock Text="View thread" Classes="text-muted" FontSize="12" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
                </Grid>

                <!-- Action Buttons - Overlay on hover, positioned top-right -->
                <Border x:Name="ActionButtonsContainer"
                        Background="{StaticResource Content1Brush}"
                        BorderBrush="{StaticResource BorderBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Padding="4"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Top"
                        Opacity="0"
                        IsHitTestVisible="False">
                    <StackPanel Orientation="Horizontal" Spacing="2">
                        <!-- Add Reaction button -->
                        <Button Classes="btn-message-action"
                                ToolTip.Tip="Add Reaction"
                                Tag="{Binding Message, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                Click="AddReactionButton_Click"
                                IsVisible="{Binding ShowReactions, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}">
                            <ui:SymbolIcon Symbol="Emoji" FontSize="14"/>
                        </Button>

                        <!-- Start Thread button -->
                        <Button Classes="btn-message-action"
                                Tag="{Binding Message, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                ToolTip.Tip="Reply in Thread"
                                Click="StartThreadButton_Click"
                                IsVisible="{Binding ShowStartThreadButton, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}">
                            <ui:SymbolIcon Symbol="Message" FontSize="14"/>
                        </Button>

                        <!-- More Options button with flyout menu -->
                        <Button x:Name="MoreOptionsButton"
                                Classes="btn-message-action"
                                ToolTip.Tip="More actions"
                                Click="MoreOptionsButton_Click">
                            <ui:SymbolIcon Symbol="MoreVertical" FontSize="14"/>
                            <Button.Flyout>
                                <MenuFlyout Placement="BottomEdgeAlignedRight">
                                    <!-- Reply -->
                                    <MenuItem Header="Reply" Click="ReplyMenuItem_Click">
                                        <MenuItem.Icon>
                                            <ui:SymbolIcon Symbol="MailReply" FontSize="14"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <!-- Pin/Unpin -->
                                    <MenuItem x:Name="PinMenuItem" Header="Pin" Click="PinMenuItem_Click">
                                        <MenuItem.Icon>
                                            <ui:SymbolIcon Symbol="Pin" FontSize="14"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <Separator/>
                                    <!-- Edit -->
                                    <MenuItem Header="Edit" Click="EditMenuItem_Click">
                                        <MenuItem.Icon>
                                            <ui:SymbolIcon Symbol="Edit" FontSize="14"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <!-- Delete -->
                                    <MenuItem Header="Delete" Click="DeleteMenuItem_Click">
                                        <MenuItem.Icon>
                                            <ui:SymbolIcon Symbol="Delete" FontSize="14"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                </MenuFlyout>
                            </Button.Flyout>
                        </Button>
                    </StackPanel>
                </Border>
            </Panel>
        </Border>
    </StackPanel>
</UserControl>
