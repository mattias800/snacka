<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:conv="using:Snacka.Client.Converters"
             xmlns:controls="using:Snacka.Client.Controls"
             xmlns:ui="using:FluentAvalonia.UI.Controls"
             mc:Ignorable="d"
             x:Class="Snacka.Client.Controls.MessageItemView"
             x:DataType="controls:MessageItemView">

    <StackPanel>
        <!-- Date separator (optional) -->
        <Border Margin="0,16,0,8" Padding="0"
                IsVisible="{Binding ShowDateSeparator, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}">
            <Grid>
                <Separator Background="{StaticResource BorderBrush}" Margin="0,8"/>
                <Border Background="{StaticResource Content2Brush}" HorizontalAlignment="Center" Padding="12,4" CornerRadius="12">
                    <TextBlock Text="{Binding CreatedAt, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}, Converter={x:Static conv:DateSeparatorTextConverter.Instance}}"
                               Classes="text-caption"/>
                </Border>
            </Grid>
        </Border>

        <Border Margin="0,8" Padding="8" x:Name="MessageBorder" HorizontalAlignment="Stretch" CornerRadius="12">
            <Grid HorizontalAlignment="Stretch">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Avatar -->
                <Border Grid.Column="0"
                        Width="40" Height="40"
                        CornerRadius="20"
                        Background="{StaticResource PrimaryGradient}"
                        VerticalAlignment="Top"
                        Margin="0,0,12,0">
                    <TextBlock Text="{Binding AuthorUsername, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}, Converter={x:Static conv:FirstCharConverter.Instance}}"
                               Foreground="White"
                               FontSize="16"
                               FontWeight="Bold"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"/>
                </Border>

                <!-- Message Content -->
                <StackPanel Grid.Column="1">
                    <!-- Reply Preview (if this message is a reply) -->
                    <Border Background="{StaticResource Content1Brush}"
                            CornerRadius="10"
                            Padding="10,6"
                            Margin="0,0,0,6"
                            BorderBrush="{StaticResource PrimaryBrush}"
                            BorderThickness="2,0,0,0"
                            IsVisible="{Binding ReplyTo, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <ui:SymbolIcon Symbol="MailReply" Foreground="{StaticResource PrimaryBrush}" FontSize="12" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding ReplyTo.AuthorUsername, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                       Foreground="{StaticResource PrimaryBrush}"
                                       FontSize="12"
                                       FontWeight="SemiBold"
                                       VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding ReplyTo.Content, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                       Classes="text-muted"
                                       FontSize="12"
                                       TextTrimming="CharacterEllipsis"
                                       MaxWidth="400"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding AuthorUsername, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                   Classes="heading-3"
                                   FontSize="15"/>
                        <TextBlock Text="{Binding CreatedAt, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}, Converter={x:Static conv:RelativeTimestampConverter.Instance}}"
                                   ToolTip.Tip="{Binding CreatedAt, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}, Converter={x:Static conv:FullTimestampConverter.Instance}}"
                                   Classes="text-muted"
                                   FontSize="12"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="(edited)"
                                   Classes="text-muted"
                                   FontSize="11"
                                   VerticalAlignment="Center"
                                   IsVisible="{Binding IsEdited, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"/>
                    </StackPanel>

                    <controls:MessageContentBlock Content="{Binding MessageContent, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                                  FontSize="15"
                                                  Margin="0,4,0,0"/>

                    <!-- Attachments Display -->
                    <ItemsControl x:Name="AttachmentsControl"
                                  ItemsSource="{Binding Attachments, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                  Margin="0,8,0,0">
                        <ItemsControl.IsVisible>
                            <MultiBinding Converter="{x:Static BoolConverters.And}">
                                <Binding Path="ShowAttachments" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}"/>
                                <Binding Path="Attachments" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}" Converter="{x:Static ObjectConverters.IsNotNull}"/>
                            </MultiBinding>
                        </ItemsControl.IsVisible>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <controls:AttachmentPreview Attachment="{Binding}"
                                                           BaseUrl="{Binding BaseUrl, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                                           ImageClicked="AttachmentPreview_ImageClicked"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Reactions Display -->
                    <ItemsControl ItemsSource="{Binding Reactions, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                                  Margin="0,8,0,0">
                        <ItemsControl.IsVisible>
                            <MultiBinding Converter="{x:Static BoolConverters.And}">
                                <Binding Path="ShowReactions" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}"/>
                                <Binding Path="Reactions" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}" Converter="{x:Static ObjectConverters.IsNotNull}"/>
                            </MultiBinding>
                        </ItemsControl.IsVisible>
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="6"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Classes="reaction-chip"
                                        Padding="6,4"
                                        CornerRadius="10"
                                        Cursor="Hand"
                                        Tag="{Binding}"
                                        PointerPressed="ReactionChip_PointerPressed">
                                    <Border.Background>
                                        <SolidColorBrush Color="{Binding HasReacted, Converter={x:Static conv:ReactionBackgroundConverter.Instance}}"/>
                                    </Border.Background>
                                    <StackPanel Orientation="Horizontal" Spacing="6">
                                        <TextBlock Text="{Binding Emoji}" FontSize="14"/>
                                        <TextBlock Text="{Binding Count}" Classes="text-body" FontSize="12" VerticalAlignment="Center"/>
                                    </StackPanel>
                                    <ToolTip.Tip>
                                        <ItemsControl ItemsSource="{Binding Users}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Username}" Foreground="White"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ToolTip.Tip>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Thread Indicator (only when there are replies and ShowThreadIndicator is true) -->
                    <Border Margin="0,8,0,0"
                            Padding="10,8"
                            Background="{StaticResource Content3Brush}"
                            CornerRadius="10"
                            Cursor="Hand"
                            Tag="{Binding Message, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                            PointerPressed="ThreadIndicator_PointerPressed">
                        <Border.IsVisible>
                            <MultiBinding Converter="{x:Static BoolConverters.And}">
                                <Binding Path="ShowThreadIndicator" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}"/>
                                <Binding Path="ReplyCount" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}" Converter="{x:Static conv:IntGreaterThanZeroConverter.Instance}"/>
                            </MultiBinding>
                        </Border.IsVisible>
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Foreground="{StaticResource PrimaryBrush}" FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center">
                                <TextBlock.Text>
                                    <MultiBinding StringFormat="{}{0} {1}">
                                        <Binding Path="ReplyCount" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}"/>
                                        <Binding Path="ReplyCount" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}" Converter="{x:Static conv:PluralizeConverter.Instance}" ConverterParameter="reply|replies"/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                            <TextBlock Text="View thread" Classes="text-muted" FontSize="12" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Action Buttons -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4" VerticalAlignment="Top">
                    <!-- Add Reaction button (only when ShowReactions is true) -->
                    <Button Classes="btn-icon"
                            ToolTip.Tip="Add Reaction"
                            Tag="{Binding Message, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                            Click="AddReactionButton_Click"
                            IsVisible="{Binding ShowReactions, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}">
                        <ui:SymbolIcon Symbol="Emoji" Foreground="{StaticResource Foreground3Brush}" FontSize="12"/>
                    </Button>

                    <!-- Start Thread button (only when ShowStartThreadButton is true and no replies yet) -->
                    <Button Classes="btn-icon"
                            Tag="{Binding Message, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                            ToolTip.Tip="Start Thread"
                            Click="StartThreadButton_Click">
                        <Button.IsVisible>
                            <MultiBinding Converter="{x:Static BoolConverters.And}">
                                <Binding Path="ShowStartThreadButton" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}"/>
                                <Binding Path="ReplyCount" RelativeSource="{RelativeSource AncestorType=controls:MessageItemView}" Converter="{x:Static conv:IntEqualsZeroConverter.Instance}"/>
                            </MultiBinding>
                        </Button.IsVisible>
                        <ui:SymbolIcon Symbol="Message" Foreground="{StaticResource Foreground3Brush}" FontSize="12"/>
                    </Button>

                    <!-- Pin button (only when ShowPinButton is true) -->
                    <Button Classes="btn-icon"
                            Command="{Binding TogglePinCommand, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                            CommandParameter="{Binding Message, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                            ToolTip.Tip="{Binding IsPinned, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}, Converter={x:Static conv:BoolToStringConverter.Instance}, ConverterParameter='Unpin|Pin'}"
                            IsVisible="{Binding ShowPinButton, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}">
                        <ui:SymbolIcon Symbol="Pin"
                                   Foreground="{Binding IsPinned, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}, Converter={x:Static conv:BoolToColorConverter.Instance}, ConverterParameter='#faa61a|#80848e'}"
                                   FontSize="12"/>
                    </Button>

                    <!-- Reply button (only when ShowReplyButton is true) -->
                    <Button Classes="btn-icon"
                            Command="{Binding ReplyToMessageCommand, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                            CommandParameter="{Binding Message, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                            ToolTip.Tip="Reply"
                            IsVisible="{Binding ShowReplyButton, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}">
                        <ui:SymbolIcon Symbol="MailReply" Foreground="{StaticResource Foreground3Brush}" FontSize="12"/>
                    </Button>

                    <Button Classes="btn-icon"
                            Command="{Binding StartEditMessageCommand, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                            CommandParameter="{Binding Message, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                            ToolTip.Tip="Edit">
                        <ui:SymbolIcon Symbol="Edit" Foreground="{StaticResource Foreground3Brush}" FontSize="12"/>
                    </Button>

                    <Button Classes="btn-icon"
                            Command="{Binding DeleteMessageCommand, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                            CommandParameter="{Binding Message, RelativeSource={RelativeSource AncestorType=controls:MessageItemView}}"
                            ToolTip.Tip="Delete">
                        <ui:SymbolIcon Symbol="Delete" Foreground="{StaticResource Foreground3Brush}" FontSize="12"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
    </StackPanel>
</UserControl>
