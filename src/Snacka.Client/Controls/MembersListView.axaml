<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:conv="using:Snacka.Client.Converters"
             xmlns:controls="using:Snacka.Client.Controls"
             xmlns:services="using:Snacka.Client.Services"
             xmlns:vm="using:Snacka.Client.ViewModels"
             xmlns:ui="using:FluentAvalonia.UI.Controls"
             mc:Ignorable="d"
             x:Class="Snacka.Client.Controls.MembersListView"
             x:DataType="controls:MembersListView">

    <Border Background="{StaticResource Content1Brush}">
        <ScrollViewer Margin="0,8,0,0"
                      HorizontalScrollBarVisibility="Disabled">
            <ItemsControl x:Name="MembersList"
                          ItemsSource="{Binding ViewModel.SortedMembers, RelativeSource={RelativeSource AncestorType=controls:MembersListView}}"
                          Margin="8,0"
                          HorizontalAlignment="Stretch">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel HorizontalAlignment="Stretch"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="services:CommunityMemberResponse">
                        <Panel HorizontalAlignment="Stretch">
                            <!-- Current user (with context menu for nickname) -->
                            <Border Classes="member-item"
                                        Padding="10,6"
                                        Margin="0,2"
                                        Cursor="Hand"
                                        HorizontalAlignment="Stretch"
                                        Tag="{Binding}">
                                    <Border.IsVisible>
                                        <MultiBinding Converter="{x:Static conv:GuidEqualsConverter.Instance}">
                                            <Binding Path="UserId"/>
                                            <Binding Path="ViewModel.CurrentUserId" RelativeSource="{RelativeSource AncestorType=controls:MembersListView}"/>
                                        </MultiBinding>
                                    </Border.IsVisible>
                                    <Border.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="Change Nickname"
                                                      Click="OnChangeMyNicknameClick"/>
                                        </ContextMenu>
                                    </Border.ContextMenu>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Avatar with online indicator -->
                                        <Grid Grid.Column="0" Margin="0,0,10,0">
                                            <Border Width="32" Height="32"
                                                    CornerRadius="16"
                                                    Background="{StaticResource PrimaryGradient}">
                                                <TextBlock Text="{Binding Username, Converter={x:Static conv:FirstCharConverter.Instance}}"
                                                           Foreground="White"
                                                           FontSize="14"
                                                           FontWeight="Bold"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                            </Border>
                                            <Ellipse Width="12" Height="12"
                                                     Fill="{StaticResource SuccessBrush}"
                                                     Stroke="{StaticResource Content1Brush}"
                                                     StrokeThickness="2"
                                                     HorizontalAlignment="Right"
                                                     VerticalAlignment="Bottom"
                                                     IsVisible="{Binding IsOnline}"/>
                                        </Grid>

                                        <!-- Display Name (You) and Role -->
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <TextBlock Text="{Binding EffectiveDisplayName}"
                                                           Classes="text-body"
                                                           FontSize="14"/>
                                                <TextBlock Text="(You)"
                                                           Classes="text-muted"
                                                           FontSize="14"/>
                                            </StackPanel>
                                            <TextBlock Text="{Binding Role}"
                                                       Classes="text-muted"
                                                       FontSize="10"
                                                       Margin="0,-2,0,0"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>

                                <!-- Other members (clickable) -->
                                <Border Classes="member-item"
                                        Padding="10,6"
                                        Margin="0,2"
                                        Cursor="Hand"
                                        HorizontalAlignment="Stretch"
                                        PointerPressed="Member_PointerPressed"
                                        Tag="{Binding}">
                                    <Border.IsVisible>
                                        <MultiBinding Converter="{x:Static conv:GuidNotEqualsConverter.Instance}">
                                            <Binding Path="UserId"/>
                                            <Binding Path="ViewModel.CurrentUserId" RelativeSource="{RelativeSource AncestorType=controls:MembersListView}"/>
                                        </MultiBinding>
                                    </Border.IsVisible>
                                    <Border.ContextMenu>
                                        <ContextMenu Opened="OnMemberContextMenuOpened">
                                            <MenuItem Header="Send Direct Message"
                                                      Click="OnStartDMClick"/>
                                            <Separator x:Name="AdminSeparator1"/>
                                            <MenuItem Header="Change Nickname"
                                                      x:Name="ChangeNicknameItem"
                                                      Click="OnChangeMemberNicknameClick"/>
                                            <MenuItem Header="Promote to Admin"
                                                      x:Name="PromoteItem"
                                                      Click="OnPromoteToAdminClick"
                                                      IsEnabled="{Binding Role, Converter={x:Static conv:CanPromoteConverter.Instance}}"/>
                                            <MenuItem Header="Demote to Member"
                                                      x:Name="DemoteItem"
                                                      Click="OnDemoteToMemberClick"
                                                      IsEnabled="{Binding Role, Converter={x:Static conv:CanDemoteConverter.Instance}}"/>
                                            <Separator x:Name="AdminSeparator2"/>
                                            <MenuItem Header="Transfer Ownership"
                                                      x:Name="TransferItem"
                                                      Click="OnTransferOwnershipClick"
                                                      IsEnabled="{Binding Role, Converter={x:Static conv:CanTransferOwnershipConverter.Instance}}"/>
                                        </ContextMenu>
                                    </Border.ContextMenu>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Avatar with online indicator -->
                                        <Grid Grid.Column="0" Margin="0,0,10,0">
                                            <Border Width="32" Height="32"
                                                    CornerRadius="16"
                                                    Background="{StaticResource PrimaryGradient}">
                                                <TextBlock Text="{Binding Username, Converter={x:Static conv:FirstCharConverter.Instance}}"
                                                           Foreground="White"
                                                           FontSize="14"
                                                           FontWeight="Bold"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                            </Border>
                                            <Ellipse Width="12" Height="12"
                                                     Fill="{StaticResource SuccessBrush}"
                                                     Stroke="{StaticResource Content1Brush}"
                                                     StrokeThickness="2"
                                                     HorizontalAlignment="Right"
                                                     VerticalAlignment="Bottom"
                                                     IsVisible="{Binding IsOnline}"/>
                                        </Grid>

                                        <!-- Display Name and Role -->
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding EffectiveDisplayName}"
                                                       Classes="text-body"
                                                       FontSize="14"/>
                                            <TextBlock Text="{Binding Role}"
                                                       Classes="text-muted"
                                                       FontSize="10"
                                                       Margin="0,-2,0,0"/>
                                        </StackPanel>

                                        <!-- Unread DM Badge -->
                                        <Border Grid.Column="2"
                                                Background="{StaticResource DangerBrush}"
                                                CornerRadius="10"
                                                Padding="6,2"
                                                VerticalAlignment="Center"
                                                Margin="4,0,0,0">
                                            <Border.IsVisible>
                                                <MultiBinding Converter="{x:Static conv:DmUnreadCountConverter.Instance}" ConverterParameter="visibility">
                                                    <Binding Path="UserId"/>
                                                    <Binding Path="ViewModel" RelativeSource="{RelativeSource AncestorType=controls:MembersListView}"/>
                                                </MultiBinding>
                                            </Border.IsVisible>
                                            <TextBlock Foreground="White"
                                                       FontSize="11"
                                                       FontWeight="SemiBold">
                                                <TextBlock.Text>
                                                    <MultiBinding Converter="{x:Static conv:DmUnreadCountConverter.Instance}">
                                                        <Binding Path="UserId"/>
                                                        <Binding Path="ViewModel" RelativeSource="{RelativeSource AncestorType=controls:MembersListView}"/>
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </Border>
                                    </Grid>
                                </Border>
                            </Panel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
        </ScrollViewer>
    </Border>
</UserControl>
