<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Snacka.Client.ViewModels"
             xmlns:ui="using:FluentAvalonia.UI.Controls"
             xmlns:controls="using:Snacka.Client.Controls"
             x:Class="Snacka.Client.Views.VideoSettingsView"
             x:DataType="vm:VideoSettingsViewModel">

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Spacing="28" MaxWidth="700">
            <!-- Header -->
            <TextBlock Text="Video"
                       FontSize="24"
                       FontWeight="Bold"
                       Foreground="{StaticResource ForegroundBrush}"/>

            <!-- Camera Device Section -->
            <StackPanel Spacing="10">
                <TextBlock Text="CAMERA"
                           FontSize="11"
                           FontWeight="SemiBold"
                           Foreground="{StaticResource Foreground3Brush}"/>
                <StackPanel Orientation="Horizontal" Spacing="12">
                    <ComboBox ItemsSource="{Binding VideoDevices}"
                              SelectedValue="{Binding SelectedVideoDevice}"
                              SelectedValueBinding="{Binding Value}"
                              DisplayMemberBinding="{Binding DisplayName}"
                              Background="{StaticResource Content1Brush}"
                              Foreground="{StaticResource ForegroundBrush}"
                              MinWidth="320"
                              Padding="14,10"
                              CornerRadius="10"/>
                    <Button Command="{Binding RefreshDevicesCommand}"
                            Classes="btn-icon"
                            Padding="10"
                            ToolTip.Tip="Refresh camera devices">
                        <ui:SymbolIcon Symbol="Sync" Foreground="{StaticResource Foreground2Brush}" FontSize="16"/>
                    </Button>
                </StackPanel>
            </StackPanel>

            <!-- Quality Settings Section -->
            <Border Background="{StaticResource Content1Brush}" CornerRadius="16" Padding="24">
                <StackPanel Spacing="16">
                    <TextBlock Text="QUALITY"
                               FontSize="11"
                               FontWeight="SemiBold"
                               Foreground="{StaticResource Foreground3Brush}"/>

                    <!-- Resolution -->
                    <Grid ColumnDefinitions="120,*">
                        <TextBlock Text="Resolution"
                                   FontSize="13"
                                   Foreground="{StaticResource Foreground2Brush}"
                                   VerticalAlignment="Center"/>
                        <ComboBox Grid.Column="1"
                                  ItemsSource="{Binding ResolutionOptions}"
                                  SelectedValue="{Binding SelectedHeight}"
                                  SelectedValueBinding="{Binding Value}"
                                  DisplayMemberBinding="{Binding DisplayName}"
                                  Background="{StaticResource BackgroundBrush}"
                                  Foreground="{StaticResource ForegroundBrush}"
                                  MinWidth="180"
                                  Padding="12,8"
                                  CornerRadius="8"/>
                    </Grid>

                    <!-- Framerate -->
                    <Grid ColumnDefinitions="120,*">
                        <TextBlock Text="Framerate"
                                   FontSize="13"
                                   Foreground="{StaticResource Foreground2Brush}"
                                   VerticalAlignment="Center"/>
                        <ComboBox Grid.Column="1"
                                  ItemsSource="{Binding FramerateOptions}"
                                  SelectedValue="{Binding SelectedFramerate}"
                                  SelectedValueBinding="{Binding Value}"
                                  DisplayMemberBinding="{Binding DisplayName}"
                                  Background="{StaticResource BackgroundBrush}"
                                  Foreground="{StaticResource ForegroundBrush}"
                                  MinWidth="180"
                                  Padding="12,8"
                                  CornerRadius="8"/>
                    </Grid>

                    <!-- Bitrate -->
                    <Grid ColumnDefinitions="120,*">
                        <TextBlock Text="Bitrate"
                                   FontSize="13"
                                   Foreground="{StaticResource Foreground2Brush}"
                                   VerticalAlignment="Center"/>
                        <ComboBox Grid.Column="1"
                                  ItemsSource="{Binding BitrateOptions}"
                                  SelectedValue="{Binding SelectedBitrate}"
                                  SelectedValueBinding="{Binding Value}"
                                  DisplayMemberBinding="{Binding DisplayName}"
                                  Background="{StaticResource BackgroundBrush}"
                                  Foreground="{StaticResource ForegroundBrush}"
                                  MinWidth="180"
                                  Padding="12,8"
                                  CornerRadius="8"/>
                    </Grid>

                    <TextBlock Text="Higher bitrate improves quality but uses more bandwidth."
                               FontSize="11"
                               Foreground="{StaticResource Foreground3Brush}"
                               Margin="0,4,0,0"/>
                </StackPanel>
            </Border>

            <!-- Camera Test Section -->
            <Border Background="{StaticResource Content1Brush}" CornerRadius="16" Padding="24">
                <StackPanel Spacing="20">
                    <TextBlock Text="CAMERA TEST"
                               FontSize="11"
                               FontWeight="SemiBold"
                               Foreground="{StaticResource Foreground3Brush}"/>

                    <!-- Test Button -->
                    <Panel MinWidth="140" HorizontalAlignment="Left">
                        <Button Command="{Binding TestCameraCommand}"
                                Classes="btn-primary"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center"
                                IsVisible="{Binding !IsTestingCamera}">
                            <TextBlock Text="Test Camera" FontWeight="SemiBold"/>
                        </Button>
                        <Button Command="{Binding TestCameraCommand}"
                                Classes="btn-danger"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center"
                                IsVisible="{Binding IsTestingCamera}">
                            <TextBlock Text="Stop Test" FontWeight="SemiBold" Foreground="White"/>
                        </Button>
                    </Panel>

                    <!-- Camera Preview (GPU-accelerated with software fallback) -->
                    <StackPanel Spacing="8" IsVisible="{Binding IsTestingCamera}">
                        <TextBlock Text="Preview"
                                   FontSize="12"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource Foreground2Brush}"/>
                        <Border Background="{StaticResource BackgroundBrush}"
                                CornerRadius="10"
                                Padding="4"
                                HorizontalAlignment="Left"
                                ClipToBounds="True">
                            <Panel Width="320" Height="180">
                                <!-- GPU renderer (primary) -->
                                <controls:GpuVideoView x:Name="PreviewView"
                                                       Width="320"
                                                       Height="180"/>
                                <!-- Software fallback -->
                                <Image x:Name="PreviewFallback"
                                       Width="320"
                                       Height="180"
                                       Stretch="Uniform"
                                       IsVisible="False"/>
                            </Panel>
                        </Border>
                        <TextBlock FontSize="11" Foreground="{StaticResource Foreground3Brush}">
                            <Run Text="Frames: "/>
                            <Run Text="{Binding FrameCount}"/>
                        </TextBlock>
                    </StackPanel>

                    <!-- Camera Status -->
                    <StackPanel Spacing="8" IsVisible="{Binding IsTestingCamera}">
                        <Grid ColumnDefinitions="Auto,*">
                            <TextBlock Text="Status:"
                                       FontSize="12"
                                       Foreground="{StaticResource Foreground3Brush}"/>
                            <TextBlock Grid.Column="1"
                                       Text="{Binding CameraStatus}"
                                       FontSize="12"
                                       Foreground="{StaticResource SuccessBrush}"
                                       Margin="8,0,0,0"/>
                        </Grid>
                        <Grid ColumnDefinitions="Auto,*">
                            <TextBlock Text="Resolution:"
                                       FontSize="12"
                                       Foreground="{StaticResource Foreground3Brush}"/>
                            <TextBlock Grid.Column="1"
                                       Text="{Binding Resolution}"
                                       FontSize="12"
                                       Foreground="{StaticResource ForegroundBrush}"
                                       Margin="8,0,0,0"/>
                        </Grid>
                    </StackPanel>

                    <!-- Instructions when not testing -->
                    <TextBlock Text="Click 'Test Camera' to see a preview of what others will see when you share your camera."
                               FontSize="12"
                               Foreground="{StaticResource Foreground3Brush}"
                               TextWrapping="Wrap"
                               IsVisible="{Binding !IsTestingCamera}"/>
                </StackPanel>
            </Border>

            <!-- Info Text -->
            <TextBlock Text="Changes are saved automatically when you select a new option."
                       FontSize="12"
                       Foreground="{StaticResource Foreground3Brush}"
                       Margin="0,8,0,0"/>

            <!-- FFmpeg requirement notice -->
            <Border Background="{StaticResource Content1Brush}" CornerRadius="16" Padding="24">
                <StackPanel Spacing="10">
                    <TextBlock Text="REQUIREMENTS"
                               FontSize="11"
                               FontWeight="SemiBold"
                               Foreground="{StaticResource Foreground3Brush}"/>
                    <TextBlock Text="Video capture requires FFmpeg to be installed:"
                               FontSize="12"
                               Foreground="{StaticResource Foreground3Brush}"
                               TextWrapping="Wrap"/>
                    <TextBlock Text="macOS: brew install ffmpeg"
                               FontSize="12"
                               Foreground="{StaticResource Foreground2Brush}"
                               FontFamily="Consolas,Monaco,monospace"/>
                    <TextBlock Text="Windows: winget install ffmpeg"
                               FontSize="12"
                               Foreground="{StaticResource Foreground2Brush}"
                               FontFamily="Consolas,Monaco,monospace"/>
                    <TextBlock Text="Linux: apt install ffmpeg"
                               FontSize="12"
                               Foreground="{StaticResource Foreground2Brush}"
                               FontFamily="Consolas,Monaco,monospace"/>
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>
</UserControl>
