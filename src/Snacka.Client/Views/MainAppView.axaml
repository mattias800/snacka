<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Snacka.Client.ViewModels"
             xmlns:controls="using:Snacka.Client.Controls"
             xmlns:conv="using:Snacka.Client.Converters"
             xmlns:services="using:Snacka.Client.Services"
             xmlns:views="using:Snacka.Client.Views"
             xmlns:ui="using:FluentAvalonia.UI.Controls"
             xmlns:sharedui="using:Snacka.Client.UI"
             x:Class="Snacka.Client.Views.MainAppView"
             x:DataType="vm:MainAppViewModel"
             x:CompileBindings="False">
    <UserControl.Resources>
        <conv:ColorToBorderConverter x:Key="ColorToBorderConverter"/>
    </UserControl.Resources>
    <Grid Background="{StaticResource BackgroundBrush}" RowDefinitions="Auto,*">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="72"/>
            <ColumnDefinition Width="260" MinWidth="180" MaxWidth="400"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="260" MinWidth="180" MaxWidth="400"/>
        </Grid.ColumnDefinitions>

        <!-- Connection Status Banner (top of screen, spans all columns) -->
        <Border Grid.Row="0" Grid.ColumnSpan="6"
                Background="{StaticResource DangerBrush}"
                Padding="12,8"
                IsVisible="{Binding IsDisconnected}">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="8">
                <TextBlock Text="Connection lost. Check your internet connection."
                           Foreground="White"
                           FontWeight="SemiBold"
                           VerticalAlignment="Center"/>
            </StackPanel>
        </Border>

        <Border Grid.Row="0" Grid.ColumnSpan="6"
                Background="{StaticResource WarningBrush}"
                Padding="8,6"
                IsVisible="{Binding IsReconnecting}">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="8">
                <TextBlock Text="{Binding ReconnectStatusText}"
                           Foreground="White"
                           FontWeight="SemiBold"
                           VerticalAlignment="Center"/>
            </StackPanel>
        </Border>

        <!-- Main Content Grid (Row 1) -->
        <Grid x:Name="MainContentGrid" Grid.Row="1" Grid.ColumnSpan="6">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="72"/>
                <ColumnDefinition Width="260" MinWidth="180" MaxWidth="400"/>  <!-- Index 1: ChannelListColumn -->
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="260" MinWidth="180" MaxWidth="400"/>  <!-- Index 5: MembersListColumn -->
            </Grid.ColumnDefinitions>

        <!-- Community List (Left Sidebar) -->
        <controls:CommunityListView Grid.Column="0"
                                    Communities="{Binding Communities}"
                                    IsLoading="{Binding IsLoading}"
                                    SelectCommunityCommand="{Binding SelectCommunityCommand}"
                                    CreateCommunityCommand="{Binding CreateCommunityCommand}"
                                    OpenDMsCommand="{Binding OpenDMsCommand}"/>

        <!-- Channel List (Second Column) -->
        <Border Grid.Column="1" Background="{StaticResource Content1Brush}">
            <DockPanel>
                <!-- Community Name Header -->
                <Border DockPanel.Dock="Top" Background="{StaticResource Content1Brush}" Padding="16,12" BorderThickness="0,0,0,1" BorderBrush="{StaticResource BackgroundBrush}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0"
                                   Text="{Binding SelectedCommunity.Name, FallbackValue='Select a Community'}"
                                   Foreground="White"
                                   FontWeight="SemiBold"
                                   FontSize="16"
                                   VerticalAlignment="Center"/>
                        <!-- Invite User Button -->
                        <Button Grid.Column="1"
                                Classes="btn-icon"
                                Command="{Binding OpenInviteUserPopupCommand}"
                                ToolTip.Tip="Invite Users"
                                Padding="6"
                                MinWidth="28"
                                MinHeight="28"
                                IsVisible="{Binding SelectedCommunity, Converter={x:Static ObjectConverters.IsNotNull}}">
                            <ui:SymbolIcon Symbol="People"
                                       Foreground="{StaticResource Foreground3Brush}"
                                       FontSize="16"/>
                        </Button>
                    </Grid>
                </Border>

                <!-- User Panel at Bottom (always visible, docked first to be at very bottom) -->
                <controls:UserPanelView DockPanel.Dock="Bottom"
                                        Username="{Binding Username}"
                                        IsSpeaking="{Binding IsSpeaking}"
                                        IsMuted="{Binding IsMuted}"
                                        IsDeafened="{Binding IsDeafened}"
                                        ToggleMuteCommand="{Binding ToggleMuteCommand}"
                                        ToggleDeafenCommand="{Binding ToggleDeafenCommand}"
                                        OpenSettingsCommand="{Binding OpenSettingsCommand}"
                                        AudioDeviceButtonClicked="OnUserPanelAudioDeviceButtonClick"/>

                <!-- Voice Connected Panel (shows when in voice channel, above user panel) -->
                <controls:VoiceConnectedPanelView DockPanel.Dock="Bottom"
                                                  IsInVoiceChannel="{Binding IsInVoiceChannel}"
                                                  IsVoiceConnected="{Binding IsVoiceConnected}"
                                                  IsVoiceConnecting="{Binding IsVoiceConnecting}"
                                                  VoiceConnectionStatusText="{Binding VoiceConnectionStatusText}"
                                                  CurrentVoiceChannel="{Binding CurrentVoiceChannel}"
                                                  IsCameraOn="{Binding IsCameraOn}"
                                                  IsScreenSharing="{Binding IsScreenSharing}"
                                                  IsDrawingAllowedForViewers="{Binding IsDrawingAllowedForViewers, Mode=TwoWay}"
                                                  ToggleCameraCommand="{Binding ToggleCameraCommand}"
                                                  ToggleScreenShareCommand="{Binding ToggleScreenShareCommand}"
                                                  LeaveVoiceChannelCommand="{Binding LeaveVoiceChannelCommand}"
                                                  ShowVoiceVideoOverlayCommand="{Binding ShowVoiceVideoOverlayCommand}"
                                                  IsVoiceInDifferentCommunity="{Binding IsVoiceInDifferentCommunity}"
                                                  VoiceCommunityName="{Binding VoiceCommunityName}"/>

                <!-- Recent DMs Section -->
                <controls:RecentDmsView DockPanel.Dock="Top"
                                        Margin="0,8,0,0"
                                        RecentConversations="{Binding RecentDms}"
                                        IsExpanded="{Binding IsRecentDmsExpanded, Mode=TwoWay}"
                                        TotalUnreadCount="{Binding TotalDmUnreadCount}"
                                        SelectConversationCommand="{Binding SelectRecentDmCommand}"
                                        ViewAllCommand="{Binding OpenDMsCommand}"/>

                <!-- Channel List -->
                <controls:ChannelListView Margin="8,8,0,0"
                                          TextChannels="{Binding TextChannels}"
                                          VoiceChannels="{Binding VoiceChannelViewModels}"
                                          CurrentVoiceChannel="{Binding CurrentVoiceChannel}"
                                          CanManageChannels="{Binding CanManageChannels}"
                                          CanManageVoice="{Binding CanManageVoice}"
                                          IsLoading="{Binding IsLoading}"
                                          EditingChannel="{Binding EditingChannel}"
                                          EditingChannelName="{Binding EditingChannelName, Mode=TwoWay}"
                                          CreateChannelCommand="{Binding CreateChannelCommand}"
                                          CreateVoiceChannelCommand="{Binding CreateVoiceChannelCommand}"
                                          SelectChannelCommand="{Binding SelectChannelCommand}"
                                          StartEditChannelCommand="{Binding StartEditChannelCommand}"
                                          SaveChannelNameCommand="{Binding SaveChannelNameCommand}"
                                          CancelEditChannelCommand="{Binding CancelEditChannelCommand}"
                                          DeleteChannelCommand="{Binding DeleteChannelCommand}"
                                          ConfirmDeleteChannelCommand="{Binding ConfirmDeleteChannelCommand}"
                                          CancelDeleteChannelCommand="{Binding CancelDeleteChannelCommand}"
                                          ChannelPendingDelete="{Binding ChannelPendingDelete}"
                                          ServerMuteUserCommand="{Binding ServerMuteUserCommand}"
                                          ServerDeafenUserCommand="{Binding ServerDeafenUserCommand}"
                                          MoveUserToChannelCommand="{Binding MoveUserToChannelCommand}"
                                          ReorderChannelsCommand="{Binding ReorderChannelsCommand}"
                                          PreviewReorderCommand="{Binding PreviewReorderCommand}"
                                          CancelPreviewCommand="{Binding CancelPreviewCommand}"
                                          VoiceChannelClicked="OnVoiceChannelClicked"
                                          VoiceChannelViewRequested="OnVoiceChannelViewRequested"
                                          ParticipantDoubleClicked="OnParticipantDoubleClicked"/>
            </DockPanel>
        </Border>

        <!-- Left Sidebar Splitter -->
        <GridSplitter Grid.Column="2"
                      Width="4"
                      Background="{StaticResource Content1Brush}"
                      ResizeDirection="Columns"
                      ResizeBehavior="PreviousAndNext"
                      Cursor="SizeWestEast"
                      DragCompleted="OnLeftSplitterDragCompleted"/>

        <!-- Main Content Area (Chat, DM, or Voice Channel) -->
        <Grid Grid.Column="3">
            <!-- Empty State (shown when user has no communities) -->
            <controls:NoCommunityView CreateCommunityCommand="{Binding CreateCommunityCommand}"
                                      BrowseCommunitiesCommand="{Binding OpenCommunityDiscoveryCommand}">
                <controls:NoCommunityView.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                        <Binding Path="HasNoCommunities"/>
                        <Binding Path="IsViewingDM" Converter="{x:Static BoolConverters.Not}"/>
                    </MultiBinding>
                </controls:NoCommunityView.IsVisible>
            </controls:NoCommunityView>

            <!-- DM Content (shown when viewing DM conversation) -->
            <controls:DMContentView IsVisible="{Binding IsViewingDM}"
                                    ViewModel="{Binding DMContent}"/>

            <!-- Voice Channel Content (shown when viewing voice channel) -->
            <controls:VoiceChannelContentView IsVisible="{Binding IsViewingVoiceChannel}"
                                              SelectedVoiceChannel="{Binding SelectedVoiceChannelForViewing}"
                                              ShowAudioDeviceWarning="{Binding ShowAudioDeviceWarning}"
                                              VoiceChannelContent="{Binding VoiceChannelContent}"
                                              OpenSettingsCommand="{Binding OpenSettingsCommand}"
                                              WatchScreenShareRequested="OnVoiceChannelWatchScreenShare"
                                              StopWatchingRequested="OnVoiceChannelStopWatching"
                                              FullscreenRequested="OnVoiceChannelFullscreen"
                                              VideoTileDoubleTapped="OnVoiceChannelVideoTileDoubleTapped"
                                              ShareControllerRequested="OnVoiceChannelShareController"/>

            <!-- Chat Area (shown when not viewing DM or voice channel) -->
            <controls:ChatAreaView x:Name="ChatArea"
                                   ChannelName="{Binding SelectedChannel.Name}"
                                   ChannelTopic="{Binding SelectedChannel.Topic}"
                                   PinnedCount="{Binding PinnedCount}"
                                   IsReplying="{Binding IsReplying}"
                                   ReplyingToAuthor="{Binding ReplyingToMessage.AuthorUsername}"
                                   ReplyingToContent="{Binding ReplyingToMessage.Content}"
                                   IsAnyoneTyping="{Binding IsAnyoneTyping}"
                                   TypingIndicatorText="{Binding TypingIndicatorText}"
                                   HasPendingAttachments="{Binding HasPendingAttachments}"
                                   PendingAttachments="{Binding PendingAttachments}"
                                   IsAutocompletePopupOpen="{Binding IsAutocompletePopupOpen}"
                                   AutocompleteSuggestions="{Binding AutocompleteSuggestions}"
                                   SelectedAutocompleteIndex="{Binding SelectedAutocompleteIndex}"
                                   GifPicker="{Binding GifPicker}"
                                   IsGifsEnabled="{Binding IsGifsEnabled}"
                                   IsGifPreviewVisible="{Binding IsGifPreviewVisible}"
                                   GifPreviewResult="{Binding GifPreviewResult}"
                                   GifPreviewQuery="{Binding GifPreviewQuery}"
                                   MessageInput="{Binding MessageInput, Mode=TwoWay}"
                                   IsLoading="{Binding IsLoading}"
                                   Messages="{Binding Messages}"
                                   BaseUrl="{Binding BaseUrl}"
                                   AccessToken="{Binding AccessToken}"
                                   IsEditing="{Binding EditingMessage, Converter={x:Static ObjectConverters.IsNotNull}}"
                                   EditingMessageContent="{Binding EditingMessageContent, Mode=TwoWay}"
                                   ShowPinnedMessagesCommand="{Binding ShowPinnedMessagesCommand}"
                                   CancelReplyCommand="{Binding CancelReplyCommand}"
                                   SendMessageCommand="{Binding SendMessageCommand}"
                                   TogglePinCommand="{Binding TogglePinCommand}"
                                   ReplyToMessageCommand="{Binding ReplyToMessageCommand}"
                                   StartEditMessageCommand="{Binding StartEditMessageCommand}"
                                   DeleteMessageCommand="{Binding DeleteMessageCommand}"
                                   CancelEditMessageCommand="{Binding CancelEditMessageCommand}"
                                   SaveMessageEditCommand="{Binding SaveMessageEditCommand}"
                                   SendGifPreviewCommand="{Binding SendGifPreviewCommand}"
                                   ShuffleGifPreviewCommand="{Binding ShuffleGifPreviewCommand}"
                                   CancelGifPreviewCommand="{Binding CancelGifPreviewCommand}"
                                   AddReactionRequested="OnChatAreaAddReactionRequested"
                                   StartThreadRequested="OnChatAreaStartThreadRequested"
                                   ViewThreadRequested="OnChatAreaViewThreadRequested"
                                   ReactionToggleRequested="OnChatAreaReactionToggleRequested"
                                   ImageClicked="OnChatAreaImageClicked"
                                   AutocompleteSuggestionSelected="OnChatAreaAutocompleteSuggestionSelected"
                                   GifButtonClicked="OnChatAreaGifButtonClicked"
                                   AttachButtonClicked="OnChatAreaAttachButtonClicked"
                                   RemovePendingAttachmentRequested="OnChatAreaRemovePendingAttachment"
                                   FileDropped="OnChatAreaFileDropped"
                                   NavigateAutocompleteUp="OnChatAreaNavigateAutocompleteUp"
                                   NavigateAutocompleteDown="OnChatAreaNavigateAutocompleteDown"
                                   SelectCurrentAutocompleteSuggestion="OnChatAreaSelectCurrentAutocompleteSuggestion"
                                   CloseAutocompletePopup="OnChatAreaCloseAutocompletePopup">
                <controls:ChatAreaView.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                        <Binding Path="IsViewingDM" Converter="{x:Static BoolConverters.Not}"/>
                        <Binding Path="IsViewingVoiceChannel" Converter="{x:Static BoolConverters.Not}"/>
                        <Binding Path="HasNoCommunities" Converter="{x:Static BoolConverters.Not}"/>
                    </MultiBinding>
                </controls:ChatAreaView.IsVisible>
            </controls:ChatAreaView>
        </Grid>

        <!-- Right Sidebar Splitter -->
        <GridSplitter Grid.Column="4"
                      Width="4"
                      Background="{StaticResource Content1Brush}"
                      ResizeDirection="Columns"
                      ResizeBehavior="PreviousAndNext"
                      Cursor="SizeWestEast"
                      DragCompleted="OnRightSplitterDragCompleted"/>

        <!-- Right Sidebar (Members List + Activity Feed) -->
        <Border Grid.Column="5" Background="{StaticResource Content1Brush}">
            <Grid x:Name="RightSidebarGrid">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" MinHeight="60"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*" MinHeight="60"/>
                </Grid.RowDefinitions>

                <!-- Members List (top) -->
                <DockPanel Grid.Row="0">
                    <!-- Members Header -->
                    <sharedui:SectionHeader DockPanel.Dock="Top"
                                            Icon="People"
                                            Title="MEMBERS"/>

                    <!-- Members Content -->
                    <controls:MembersListView ViewModel="{Binding MembersList}"
                                              MemberClicked="OnMemberClicked"/>
                </DockPanel>

                <!-- Splitter (4px hit area with 1px visible line) -->
                <GridSplitter Grid.Row="1"
                              Height="4"
                              HorizontalAlignment="Stretch"
                              Background="Transparent"
                              ResizeDirection="Rows"
                              Cursor="SizeNorthSouth"
                              DragCompleted="OnActivitySplitterDragCompleted">
                    <GridSplitter.Template>
                        <ControlTemplate>
                            <Border Background="Transparent" Height="4">
                                <Border Background="{StaticResource BackgroundBrush}"
                                        Height="1"
                                        VerticalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                    </GridSplitter.Template>
                </GridSplitter>

                <!-- Activity Feed (bottom) -->
                <DockPanel Grid.Row="2">
                    <!-- Activity Header -->
                    <sharedui:SectionHeader DockPanel.Dock="Top"
                                            Icon="Alert"
                                            Title="ACTIVITY"
                                            ShowBadge="{Binding ActivityFeed.HasUnread}"
                                            BadgeCount="{Binding ActivityFeed.UnreadCount}">
                        <sharedui:SectionHeader.ActionContent>
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <!-- Mark all as read button -->
                                <Button Classes="btn-icon"
                                        Command="{Binding ActivityFeed.MarkAllAsReadCommand}"
                                        ToolTip.Tip="Mark all as read"
                                        Padding="4"
                                        MinWidth="24"
                                        MinHeight="24"
                                        IsVisible="{Binding ActivityFeed.HasUnread}">
                                    <ui:SymbolIcon Symbol="Checkmark"
                                               Foreground="{StaticResource Foreground3Brush}"
                                               FontSize="14"/>
                                </Button>
                                <!-- Clear all button -->
                                <Button Classes="btn-icon"
                                        Command="{Binding ActivityFeed.ClearAllCommand}"
                                        ToolTip.Tip="Clear all"
                                        Padding="4"
                                        MinWidth="24"
                                        MinHeight="24">
                                    <ui:SymbolIcon Symbol="Delete"
                                               Foreground="{StaticResource Foreground3Brush}"
                                               FontSize="14"/>
                                </Button>
                            </StackPanel>
                        </sharedui:SectionHeader.ActionContent>
                    </sharedui:SectionHeader>

                    <!-- Activity Content -->
                    <controls:ActivityFeedView DataContext="{Binding ActivityFeed}"/>
                </DockPanel>
            </Grid>
        </Border>

        <!-- Thread Panel Overlay (visible when thread IS open) -->
        <Border Grid.Column="3" Grid.ColumnSpan="3"
                HorizontalAlignment="Right"
                Width="{Binding ThreadPanelWidth}"
                IsVisible="{Binding CurrentThread, Converter={x:Static ObjectConverters.IsNotNull}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="4"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Resize Handle -->
                <Border Grid.Column="0"
                        Background="{StaticResource BackgroundBrush}"
                        Cursor="SizeWestEast"
                        PointerPressed="ThreadPanelResizeHandle_PointerPressed"
                        PointerMoved="ThreadPanelResizeHandle_PointerMoved"
                        PointerReleased="ThreadPanelResizeHandle_PointerReleased"/>

                <!-- Thread Content -->
                <controls:ThreadPanelView Grid.Column="1"
                                          DataContext="{Binding CurrentThread}"
                                          BaseUrl="{Binding $parent[UserControl].DataContext.BaseUrl}"
                                          AccessToken="{Binding $parent[UserControl].DataContext.AccessToken}"
                                          StartEditMessageCommand="{Binding $parent[UserControl].DataContext.StartEditMessageCommand}"
                                          DeleteMessageCommand="{Binding $parent[UserControl].DataContext.DeleteMessageCommand}"
                                          AddReactionRequested="OnThreadMessageAddReactionRequested"
                                          ReactionToggleRequested="OnThreadMessageReactionToggleRequested"
                                          ImageClicked="OnAttachmentImageClicked"/>
            </Grid>
        </Border>

        <!-- Screen Share Picker Overlay -->
        <Border Grid.ColumnSpan="6"
                Background="#80000000"
                IsVisible="{Binding IsScreenSharePickerOpen}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <views:ScreenSharePickerView DataContext="{Binding ScreenSharePicker}"
                                          HorizontalAlignment="Center"
                                          VerticalAlignment="Center"/>
        </Border>

        <!-- Voice Video Grid Overlay (shown when user explicitly opens video grid while in voice) -->
        <Border Grid.ColumnSpan="6"
                Background="#E0000000"
                IsVisible="{Binding IsVoiceVideoOverlayOpen}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                PointerPressed="OnVoiceVideoOverlayBackgroundClick">
            <Border Background="{StaticResource Content2Brush}"
                    CornerRadius="12"
                    Margin="40"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch"
                    PointerPressed="OnVoiceVideoOverlayContentClick">
                <Grid RowDefinitions="Auto,*">
                    <!-- Header with channel name and close button -->
                    <Border Grid.Row="0"
                            Background="{StaticResource Content1Brush}"
                            CornerRadius="12,12,0,0"
                            Padding="16,12">
                        <Grid ColumnDefinitions="*,Auto">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                <ui:SymbolIcon Symbol="Speaker2"
                                           Foreground="{StaticResource SuccessBrush}"
                                           FontSize="18"
                                           VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding CurrentVoiceChannel.Name}"
                                           Classes="heading-3"
                                           VerticalAlignment="Center"/>
                            </StackPanel>
                            <Button Grid.Column="1"
                                    Classes="btn-icon"
                                    Command="{Binding HideVoiceVideoOverlayCommand}"
                                    ToolTip.Tip="Close (ESC)">
                                <ui:SymbolIcon Symbol="Dismiss" Foreground="White" FontSize="14"/>
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Video Grid Content -->
                    <controls:VoiceChannelContentView Grid.Row="1"
                                                      SelectedVoiceChannel="{Binding CurrentVoiceChannel}"
                                                      ShowAudioDeviceWarning="{Binding ShowAudioDeviceWarning}"
                                                      VoiceChannelContent="{Binding VoiceChannelContent}"
                                                      OpenSettingsCommand="{Binding OpenSettingsCommand}"
                                                      WatchScreenShareRequested="OnVoiceChannelWatchScreenShare"
                                                      StopWatchingRequested="OnVoiceChannelStopWatching"
                                                      FullscreenRequested="OnVoiceChannelFullscreen"
                                                      VideoTileDoubleTapped="OnVoiceChannelVideoTileDoubleTapped"
                                                      ShareControllerRequested="OnVoiceChannelShareController"/>
                </Grid>
            </Border>
        </Border>

        <!-- Video Fullscreen Overlay -->
        <Border Grid.ColumnSpan="6"
                Background="#FF000000"
                IsVisible="{Binding IsVideoFullscreen}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <Grid RowDefinitions="Auto,*">
                <!-- Row 0: Top bar (rendered above video to ensure visibility) -->
                <!-- Row 1: Video content area -->

                <!-- Video content area (Row 1) - has its own internal Grid for layering -->
                <Grid Grid.Row="1">
                    <!-- Hardware-accelerated video (VideoToolbox/MediaFoundation/VA-API zero-copy rendering) -->
                    <controls:HardwareVideoViewHost x:Name="FullscreenHardwareVideo"
                                                     Decoder="{Binding FullscreenHardwareDecoder}"
                                                     HorizontalAlignment="Stretch"
                                                     VerticalAlignment="Stretch"
                                                     IsVisible="{Binding FullscreenHardwareDecoder, Converter={x:Static ObjectConverters.IsNotNull}}"/>

                    <!-- GPU-accelerated software video (used when hardware decoding not available but GPU rendering is) -->
                    <controls:GpuVideoView x:Name="FullscreenGpuVideo"
                                           HorizontalAlignment="Stretch"
                                           VerticalAlignment="Stretch"
                                           IsVisible="{Binding IsGpuFullscreenActive}"/>

                    <!-- Software fallback video (used when no GPU rendering is available) -->
                    <Image x:Name="FullscreenVideoImage"
                           Source="{Binding FullscreenStream.VideoBitmap}"
                           Stretch="Uniform"
                           HorizontalAlignment="Stretch"
                           VerticalAlignment="Stretch">
                        <Image.IsVisible>
                            <MultiBinding Converter="{x:Static BoolConverters.And}">
                                <Binding Path="!IsGpuFullscreenActive"/>
                                <Binding Path="FullscreenHardwareDecoder" Converter="{x:Static ObjectConverters.IsNull}"/>
                            </MultiBinding>
                        </Image.IsVisible>
                    </Image>

                    <!-- Drawing Canvas Overlay (transparent, captures drawing input when enabled) -->
                    <Canvas x:Name="AnnotationCanvas"
                            Background="Transparent"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch"
                            IsHitTestVisible="{Binding IsAnnotationEnabled}"
                            PointerPressed="OnAnnotationCanvasPointerPressed"
                            PointerMoved="OnAnnotationCanvasPointerMoved"
                            PointerReleased="OnAnnotationCanvasPointerReleased"/>

                    <!-- Username label - bottom left -->
                    <Border VerticalAlignment="Bottom"
                            HorizontalAlignment="Left"
                            Background="#80000000"
                            Padding="12,6"
                            Margin="16"
                            CornerRadius="12">
                        <TextBlock Text="{Binding FullscreenStream.Username}"
                                   Foreground="White"
                                   FontSize="14"/>
                    </Border>
                </Grid>

                <!-- Top bar with drawing toolbar, escape hint, and close button (Row 0 - above video) -->
                <Border Grid.Row="0"
                        HorizontalAlignment="Stretch"
                        Background="#80000000"
                        Padding="16,10">
                    <Grid>
                        <!-- Drawing Toolbar - left (only visible when host allows drawing) -->
                        <Border HorizontalAlignment="Left"
                                VerticalAlignment="Center"
                                Background="#E009090b"
                                CornerRadius="12"
                                Padding="8,4"
                                IsVisible="{Binding IsDrawingAllowedByHost}">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <!-- Draw mode toggle -->
                                <ToggleButton IsChecked="{Binding IsAnnotationEnabled}"
                                              Padding="8,4"
                                              Background="#40FFFFFF"
                                              Foreground="White"
                                              CornerRadius="8">
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <TextBlock Text="âœï¸" VerticalAlignment="Center" FontSize="12"/>
                                        <TextBlock Text="Draw" VerticalAlignment="Center" FontSize="11"/>
                                    </StackPanel>
                                </ToggleButton>

                                <!-- Color separator -->
                                <Border Width="1" Background="#40FFFFFF" Margin="2,2"/>

                                <!-- Color buttons -->
                                <StackPanel Orientation="Horizontal" Spacing="3">
                                    <Button Width="24" Height="24" Padding="0" CornerRadius="3"
                                            Background="#FF0000" BorderThickness="2"
                                            BorderBrush="{Binding AnnotationColor, Converter={StaticResource ColorToBorderConverter}, ConverterParameter=#FF0000}"
                                            Click="OnAnnotationColorClick" Tag="#FF0000"/>
                                    <Button Width="24" Height="24" Padding="0" CornerRadius="3"
                                            Background="#00FF00" BorderThickness="2"
                                            BorderBrush="{Binding AnnotationColor, Converter={StaticResource ColorToBorderConverter}, ConverterParameter=#00FF00}"
                                            Click="OnAnnotationColorClick" Tag="#00FF00"/>
                                    <Button Width="24" Height="24" Padding="0" CornerRadius="3"
                                            Background="#0080FF" BorderThickness="2"
                                            BorderBrush="{Binding AnnotationColor, Converter={StaticResource ColorToBorderConverter}, ConverterParameter=#0080FF}"
                                            Click="OnAnnotationColorClick" Tag="#0080FF"/>
                                    <Button Width="24" Height="24" Padding="0" CornerRadius="3"
                                            Background="#FFFF00" BorderThickness="2"
                                            BorderBrush="{Binding AnnotationColor, Converter={StaticResource ColorToBorderConverter}, ConverterParameter=#FFFF00}"
                                            Click="OnAnnotationColorClick" Tag="#FFFF00"/>
                                    <Button Width="24" Height="24" Padding="0" CornerRadius="3"
                                            Background="#FFFFFF" BorderThickness="2"
                                            BorderBrush="{Binding AnnotationColor, Converter={StaticResource ColorToBorderConverter}, ConverterParameter=#FFFFFF}"
                                            Click="OnAnnotationColorClick" Tag="#FFFFFF"/>
                                </StackPanel>

                                <!-- Clear separator -->
                                <Border Width="1" Background="#40FFFFFF" Margin="2,2"/>

                                <!-- Clear button -->
                                <Button Padding="8,4"
                                        Background="#40FFFFFF"
                                        Foreground="White"
                                        CornerRadius="8"
                                        Click="OnClearAnnotationsClick">
                                    <TextBlock Text="Clear" FontSize="11"/>
                                </Button>
                            </StackPanel>
                        </Border>

                        <!-- Escape hint - center -->
                        <StackPanel Orientation="Horizontal"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Center"
                                    Spacing="6">
                            <Border Background="#40ffffff"
                                    CornerRadius="8"
                                    Padding="6,2">
                                <TextBlock Text="ESC"
                                           Foreground="White"
                                           FontSize="11"
                                           FontWeight="SemiBold"/>
                            </Border>
                            <TextBlock Text="to exit fullscreen"
                                       Foreground="#b0b0b0"
                                       FontSize="12"
                                       VerticalAlignment="Center"/>
                        </StackPanel>

                        <!-- Right side: Controller button, Volume slider and Close button -->
                        <StackPanel HorizontalAlignment="Right"
                                    VerticalAlignment="Center"
                                    Orientation="Horizontal"
                                    Spacing="16">
                            <!-- Share Controller button (only for remote screen shares) -->
                            <Button Padding="10,6"
                                    Background="#40FFFFFF"
                                    BorderThickness="0"
                                    CornerRadius="12"
                                    Cursor="Hand"
                                    IsVisible="{Binding FullscreenStream.IsRemoteScreenShare}"
                                    Click="OnFullscreenShareControllerClick"
                                    ToolTip.Tip="Share your controller input with the host">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <ui:SymbolIcon Symbol="Games" Foreground="White" FontSize="14"/>
                                    <TextBlock x:Name="FullscreenControllerButtonText" Text="Share Controller" Foreground="White" FontSize="12" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>

                            <!-- Volume slider for remote stream audio -->
                            <StackPanel Orientation="Horizontal"
                                        Spacing="8"
                                        VerticalAlignment="Center"
                                        IsVisible="{Binding FullscreenStream.ShowVolumeSlider}">
                                <TextBlock Text="ðŸ”Š"
                                           Foreground="White"
                                           FontSize="14"
                                           VerticalAlignment="Center"/>
                                <Slider Width="100"
                                        Minimum="0"
                                        Maximum="300"
                                        Value="{Binding FullscreenStream.VolumePercent}"
                                        VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding FullscreenStream.VolumePercent, StringFormat={}{0}%}"
                                           Foreground="White"
                                           FontSize="12"
                                           Width="35"
                                           VerticalAlignment="Center"/>
                            </StackPanel>

                            <!-- Close button -->
                            <Button Padding="10,6"
                                    Background="{StaticResource DangerBrush}"
                                    BorderThickness="0"
                                    CornerRadius="12"
                                    Cursor="Hand"
                                    Click="OnCloseFullscreenClick">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <TextBlock Text="âœ•" Foreground="White" FontSize="14" VerticalAlignment="Center"/>
                                    <TextBlock Text="Close" Foreground="White" FontSize="12" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>
        </Border>

        <!-- Nickname Edit Overlay -->
        <controls:NicknameEditOverlay Grid.ColumnSpan="6"
                                      IsVisibleOverlay="{Binding IsEditingNickname}"
                                      IsEditingMyNickname="{Binding IsEditingMyNickname}"
                                      EditingNickname="{Binding EditingNickname, Mode=TwoWay}"
                                      IsLoading="{Binding IsLoading}"
                                      SaveNicknameCommand="{Binding SaveNicknameCommand}"
                                      CancelNicknameEditCommand="{Binding CancelNicknameEditCommand}"/>

        <!-- Emoji Picker Popup - anchored so bottom-right aligns with top-right of target -->
        <Popup x:Name="EmojiPickerPopup"
               IsLightDismissEnabled="True"
               Placement="TopEdgeAlignedRight"
               VerticalOffset="-4">
            <controls:EmojiPickerContent EmojiSelected="OnEmojiPickerEmojiSelected"/>
        </Popup>

        <!-- GIF Picker Popup -->
        <Popup x:Name="GifPickerPopup"
               IsLightDismissEnabled="True"
               Placement="Top"
               PlacementGravity="Top">
            <controls:GifPickerContent x:Name="GifPickerContent"
                                       GifSearchQuery="{Binding GifSearchQuery, Mode=TwoWay}"
                                       IsLoadingGifs="{Binding IsLoadingGifs}"
                                       GifResults="{Binding GifResults}"
                                       SearchGifsCommand="{Binding SearchGifsCommand}"
                                       GifSelected="OnGifPickerGifSelected"/>
        </Popup>

        <!-- Audio Device Popup -->
        <Popup x:Name="AudioDevicePopup"
               IsOpen="{Binding IsAudioDevicePopupOpen, Mode=TwoWay}"
               IsLightDismissEnabled="True"
               Placement="Bottom"
               PlacementTarget="{Binding $parent[Grid]}">
            <controls:AudioDeviceContent InputDevices="{Binding InputDevices}"
                                         SelectedInputDeviceItem="{Binding SelectedInputDeviceItem, Mode=TwoWay}"
                                         OutputDevices="{Binding OutputDevices}"
                                         SelectedOutputDeviceItem="{Binding SelectedOutputDeviceItem, Mode=TwoWay}"
                                         InputLevel="{Binding InputLevel}"
                                         PushToTalkEnabled="{Binding PushToTalkEnabled, Mode=TwoWay}"
                                         VoiceModeDescription="{Binding VoiceModeDescription}"
                                         RefreshDevicesRequested="OnAudioDeviceRefreshRequested"/>
        </Popup>

        <!-- Pinned Messages Popup -->
        <Popup IsOpen="{Binding IsPinnedPopupOpen, Mode=TwoWay}"
               IsLightDismissEnabled="True"
               Placement="Center"
               PlacementTarget="{Binding $parent[Grid]}">
            <controls:PinnedMessagesContent PinnedMessages="{Binding PinnedMessages}"
                                            ClosePinnedPopupCommand="{Binding ClosePinnedPopupCommand}"
                                            TogglePinCommand="{Binding TogglePinCommand}"/>
        </Popup>

        <!-- Invite User Popup -->
        <Popup x:Name="InviteUserPopup"
               IsOpen="{Binding IsInviteUserPopupOpen, Mode=TwoWay}"
               IsLightDismissEnabled="True"
               Placement="Center"
               PlacementTarget="{Binding $parent[Grid]}">
            <controls:InviteUserContent x:Name="InviteUserContent"
                                        CommunityName="{Binding SelectedCommunity.Name}"
                                        SearchQuery="{Binding InviteSearchQuery, Mode=TwoWay}"
                                        IsSearching="{Binding IsSearchingUsersToInvite}"
                                        SearchResults="{Binding InviteSearchResults}"
                                        HasNoResults="{Binding InviteHasNoResults}"
                                        StatusMessage="{Binding InviteStatusMessage}"
                                        IsStatusError="{Binding IsInviteStatusError}"
                                        CloseCommand="{Binding CloseInviteUserPopupCommand}"
                                        InviteUserCommand="{Binding InviteUserCommand}"
                                        SearchRequested="OnInviteUserSearchRequested"/>
        </Popup>

        <!-- Quick Switcher Popup (Cmd+K / Ctrl+K) -->
        <Popup x:Name="QuickSwitcherPopup"
               IsLightDismissEnabled="True"
               Placement="Center"
               PlacementTarget="{Binding $parent[Grid]}">
            <controls:QuickSwitcherContent x:Name="QuickSwitcherContent"/>
        </Popup>

        <!-- Message Search Popup (Cmd+F / Ctrl+F) -->
        <Popup x:Name="MessageSearchPopup"
               IsLightDismissEnabled="True"
               Placement="Center"
               PlacementTarget="{Binding $parent[Grid]}">
            <controls:MessageSearchContent x:Name="MessageSearchContent"/>
        </Popup>

        <!-- Image Lightbox Overlay -->
        <controls:ImageLightbox Grid.ColumnSpan="6"
                                Attachment="{Binding LightboxImage}"
                                BaseUrl="{Binding BaseUrl}"
                                CloseRequested="OnLightboxCloseRequested"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"/>

        <!-- Controller Access Request Notification (top-right corner) -->
        <Border Grid.ColumnSpan="6"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                Margin="16"
                IsVisible="{Binding HasPendingControllerRequests}">
            <Border Background="{StaticResource Content1Brush}"
                    BorderBrush="{StaticResource PrimaryBrush}"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16"
                    MinWidth="280"
                    MaxWidth="360">
                <StackPanel Spacing="12">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <ui:SymbolIcon Symbol="Games" FontSize="18" Foreground="{StaticResource PrimaryBrush}"/>
                        <TextBlock Text="Controller Request"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource ForegroundBrush}"/>
                    </StackPanel>

                    <ItemsControl ItemsSource="{Binding PendingControllerRequests}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{StaticResource BackgroundBrush}"
                                        CornerRadius="8"
                                        Padding="12"
                                        Margin="0,4">
                                    <StackPanel Spacing="10">
                                        <TextBlock FontSize="13" Foreground="{StaticResource ForegroundBrush}" TextWrapping="Wrap">
                                            <Run Text="{Binding RequesterUsername}" FontWeight="SemiBold"/>
                                            <Run Text=" wants to share their controller"/>
                                        </TextBlock>

                                        <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
                                            <Button Classes="btn-secondary"
                                                    Padding="12,6"
                                                    Command="{Binding $parent[UserControl].DataContext.DeclineControllerRequestCommand}"
                                                    CommandParameter="{Binding}">
                                                <TextBlock Text="Decline" FontSize="12"/>
                                            </Button>
                                            <Button Classes="btn-primary"
                                                    Padding="12,6"
                                                    Command="{Binding $parent[UserControl].DataContext.AcceptControllerRequestCommand}"
                                                    CommandParameter="{Binding}">
                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                    <ui:SymbolIcon Symbol="Checkmark" FontSize="12" Foreground="White"/>
                                                    <TextBlock Text="Accept" FontSize="12" FontWeight="SemiBold"/>
                                                </StackPanel>
                                            </Button>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>
        </Border>

        <!-- Active Controller Sessions Panel (below request panel when hosting) -->
        <Border Grid.ColumnSpan="6"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                Margin="16,100,16,16"
                IsVisible="{Binding HasActiveControllerSessions}">
            <Border Background="{StaticResource Content1Brush}"
                    BorderBrush="{StaticResource SuccessBrush}"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="16"
                    MinWidth="280"
                    MaxWidth="360">
                <StackPanel Spacing="12">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <ui:SymbolIcon Symbol="Games" FontSize="18" Foreground="{StaticResource SuccessBrush}"/>
                        <TextBlock Text="Active Controllers"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource ForegroundBrush}"/>
                    </StackPanel>

                    <ItemsControl ItemsSource="{Binding ActiveControllerSessions}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{StaticResource BackgroundBrush}"
                                        CornerRadius="8"
                                        Padding="12"
                                        Margin="0,4">
                                    <Grid ColumnDefinitions="*,Auto,Auto">
                                        <StackPanel Grid.Column="0" Spacing="2">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <TextBlock FontSize="13" Foreground="{StaticResource ForegroundBrush}" FontWeight="SemiBold"
                                                           Text="{Binding GuestUsername}"/>
                                                <!-- Muted indicator -->
                                                <ui:SymbolIcon Symbol="SpeakerOff" FontSize="12"
                                                               Foreground="{StaticResource WarningBrush}"
                                                               IsVisible="{Binding IsMuted}"
                                                               ToolTip.Tip="Controller input is muted"/>
                                            </StackPanel>
                                            <TextBlock FontSize="11" Foreground="{StaticResource Foreground3Brush}">
                                                <Run Text="Player "/>
                                                <Run Text="{Binding PlayerNumber}"/>
                                            </TextBlock>
                                        </StackPanel>

                                        <!-- Mute/Unmute button -->
                                        <Button Grid.Column="1"
                                                Classes="btn-secondary"
                                                Padding="10,6"
                                                Margin="0,0,6,0"
                                                VerticalAlignment="Center"
                                                Command="{Binding $parent[UserControl].DataContext.ToggleMuteControllerSessionCommand}"
                                                CommandParameter="{Binding}"
                                                ToolTip.Tip="Toggle mute controller input">
                                            <Panel>
                                                <ui:SymbolIcon Symbol="Speaker2" FontSize="12"
                                                               Foreground="{StaticResource ForegroundBrush}"
                                                               IsVisible="{Binding !IsMuted}"/>
                                                <ui:SymbolIcon Symbol="SpeakerOff" FontSize="12"
                                                               Foreground="{StaticResource WarningBrush}"
                                                               IsVisible="{Binding IsMuted}"/>
                                            </Panel>
                                        </Button>

                                        <!-- Disconnect button -->
                                        <Button Grid.Column="2"
                                                Classes="btn-danger"
                                                Padding="10,6"
                                                VerticalAlignment="Center"
                                                Command="{Binding $parent[UserControl].DataContext.StopControllerSessionCommand}"
                                                CommandParameter="{Binding}"
                                                ToolTip.Tip="Disconnect this controller">
                                            <ui:SymbolIcon Symbol="Dismiss" FontSize="12" Foreground="White"/>
                                        </Button>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>
        </Border>

        <!-- Community Discovery Modal Overlay -->
        <controls:CommunityDiscoveryModal Grid.ColumnSpan="6"
                                          IsOpen="{Binding IsCommunityDiscoveryOpen}"
                                          IsLoading="{Binding IsLoadingDiscovery}"
                                          ErrorMessage="{Binding DiscoveryError}"
                                          Communities="{Binding DiscoverableCommunities}"
                                          HasNoCommunities="{Binding HasNoDiscoverableCommunities}"
                                          JoiningCommunityId="{Binding JoiningCommunityId}"
                                          CloseCommand="{Binding CloseCommunityDiscoveryCommand}"
                                          RefreshCommand="{Binding RefreshDiscoverableCommunitiesCommand}"
                                          JoinCommunityCommand="{Binding JoinCommunityCommand}"
                                          CreateCommunityCommand="{Binding CreateCommunityCommand}"
                                          HorizontalAlignment="Stretch"
                                          VerticalAlignment="Stretch"/>

        <!-- Welcome Modal Overlay (shown on first login) -->
        <controls:WelcomeModal Grid.ColumnSpan="6"
                               IsOpen="{Binding IsWelcomeModalOpen}"
                               CloseCommand="{Binding CloseWelcomeModalCommand}"
                               BrowseCommunitiesCommand="{Binding WelcomeBrowseCommunitiesCommand}"
                               CreateCommunityCommand="{Binding WelcomeCreateCommunityCommand}"
                               HorizontalAlignment="Stretch"
                               VerticalAlignment="Stretch"/>
        </Grid>
    </Grid>
</UserControl>
