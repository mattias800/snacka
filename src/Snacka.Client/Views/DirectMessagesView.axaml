<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Snacka.Client.ViewModels"
             xmlns:controls="using:Snacka.Client.Controls"
             xmlns:converters="using:Snacka.Client.Converters"
             x:Class="Snacka.Client.Views.DirectMessagesView"
             x:DataType="vm:DirectMessagesViewModel"
             x:CompileBindings="False">
    <UserControl.Styles>
        <!-- Conversation item style with selected state -->
        <Style Selector="Button.conversation-btn">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style Selector="Button.conversation-btn:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="#35373c"/>
        </Style>
        <Style Selector="Button.conversation-btn:pressed /template/ ContentPresenter">
            <Setter Property="Background" Value="#3f4248"/>
        </Style>
        <Style Selector="Button.conversation-btn.selected /template/ ContentPresenter">
            <Setter Property="Background" Value="#42464d"/>
        </Style>
        <Style Selector="Button.conversation-btn.selected:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="#4a4e57"/>
        </Style>
    </UserControl.Styles>
    <Grid Background="#202225">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="72"/>
            <ColumnDefinition Width="260"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- DM Icon / Back Button -->
        <Border Grid.Column="0" Background="#202225" Padding="0,12">
            <StackPanel>
                <Button Command="{Binding BackCommand}"
                        Background="Transparent"
                        HorizontalAlignment="Center"
                        Margin="0,4"
                        Padding="0"
                        Cursor="Hand"
                        ToolTip.Tip="Back to Servers">
                    <Border Width="48" Height="48" CornerRadius="24"
                            Background="#5865f2">
                        <TextBlock Text="â†"
                                   Foreground="White"
                                   FontSize="24"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"/>
                    </Border>
                </Button>

                <Border Width="32" Height="2" Background="#36393f" Margin="8,8"/>

                <Border Width="48" Height="48" CornerRadius="24"
                        Background="#36393f"
                        HorizontalAlignment="Center">
                    <TextBlock Text="âœ‰"
                               Foreground="White"
                               FontSize="20"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"/>
                </Border>
            </StackPanel>
        </Border>

        <!-- Conversations List -->
        <Border Grid.Column="1" Background="#2f3136">
            <DockPanel>
                <Border DockPanel.Dock="Top" Background="#2f3136" Padding="16,12" BorderThickness="0,0,0,1" BorderBrush="#202225">
                    <TextBlock Text="Direct Messages"
                               Foreground="White"
                               FontWeight="SemiBold"
                               FontSize="16"/>
                </Border>

                <!-- User Panel at Bottom -->
                <Border DockPanel.Dock="Bottom" Background="#292b2f" Padding="8">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0" Width="32" Height="32" CornerRadius="16" Background="#5865f2" Margin="0,0,8,0">
                            <TextBlock Text="{Binding Username, Converter={x:Static converters:FirstCharConverter.Instance}}"
                                       Foreground="White"
                                       FontSize="14"
                                       FontWeight="Bold"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"/>
                        </Border>

                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="{Binding Username}"
                                       Foreground="White"
                                       FontSize="13"
                                       FontWeight="SemiBold"/>
                            <TextBlock Text="Online"
                                       Foreground="#3ba55c"
                                       FontSize="11"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Conversation List -->
                <ScrollViewer Margin="8,8,0,0">
                    <StackPanel>
                        <TextBlock Text="CONVERSATIONS"
                                   Foreground="#72767d"
                                   FontSize="11"
                                   FontWeight="SemiBold"
                                   Margin="8,8,8,4"/>

                        <ItemsControl x:Name="ConversationsList" ItemsSource="{Binding Conversations}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Command="{Binding #ConversationsList.DataContext.SelectConversationCommand}"
                                            CommandParameter="{Binding}"
                                            HorizontalAlignment="Stretch"
                                            HorizontalContentAlignment="Stretch"
                                            Padding="8,8"
                                            Margin="0,1"
                                            Cursor="Hand"
                                            Classes="conversation-btn"
                                            BorderThickness="0">
                                        <Button.Background>
                                            <MultiBinding Converter="{x:Static converters:IsSelectedBackgroundConverter.Instance}">
                                                <Binding />
                                                <Binding Path="DataContext.SelectedConversation" ElementName="ConversationsList" />
                                            </MultiBinding>
                                        </Button.Background>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <!-- Avatar -->
                                            <Grid Grid.Column="0" Margin="0,0,8,0">
                                                <Border Width="32" Height="32" CornerRadius="16" Background="#5865f2">
                                                    <TextBlock Text="{Binding Username, Converter={x:Static converters:FirstCharConverter.Instance}}"
                                                               Foreground="White"
                                                               FontSize="14"
                                                               FontWeight="Bold"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"/>
                                                </Border>
                                                <Ellipse Width="10" Height="10"
                                                         Fill="#3ba55c"
                                                         Stroke="#2f3136"
                                                         StrokeThickness="2"
                                                         HorizontalAlignment="Right"
                                                         VerticalAlignment="Bottom"
                                                         IsVisible="{Binding IsOnline}"/>
                                            </Grid>

                                            <!-- Username and last message -->
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Username}"
                                                           Foreground="White"
                                                           FontSize="14"
                                                           FontWeight="SemiBold"/>
                                                <TextBlock Text="{Binding LastMessage.Content}"
                                                           Foreground="#72767d"
                                                           FontSize="12"
                                                           TextTrimming="CharacterEllipsis"
                                                           MaxWidth="150"/>
                                            </StackPanel>

                                            <!-- Unread badge -->
                                            <Border Grid.Column="2"
                                                    Background="#ed4245"
                                                    CornerRadius="10"
                                                    Padding="6,2"
                                                    IsVisible="{Binding UnreadCount, Converter={x:Static converters:IntGreaterThanZeroConverter.Instance}}"
                                                    VerticalAlignment="Center">
                                                <TextBlock Text="{Binding UnreadCount}"
                                                           Foreground="White"
                                                           FontSize="11"
                                                           FontWeight="Bold"/>
                                            </Border>
                                        </Grid>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Empty state -->
                        <TextBlock Text="No conversations yet"
                                   Foreground="#72767d"
                                   FontSize="13"
                                   Margin="8,16"
                                   IsVisible="{Binding !Conversations.Count}"/>
                    </StackPanel>
                </ScrollViewer>
            </DockPanel>
        </Border>

        <!-- Chat Area -->
        <Border Grid.Column="2" Background="#36393f">
            <DockPanel>
                <!-- Header -->
                <Border DockPanel.Dock="Top" Background="#36393f" Padding="16,12" BorderThickness="0,0,0,1" BorderBrush="#202225">
                    <StackPanel Orientation="Horizontal" Spacing="8" IsVisible="{Binding SelectedConversation, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <TextBlock Text="@"
                                   Foreground="#72767d"
                                   FontSize="22"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding SelectedConversation.Username}"
                                   Foreground="White"
                                   FontWeight="SemiBold"
                                   FontSize="16"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>

                <!-- Message Input -->
                <Border DockPanel.Dock="Bottom" Padding="16,8,16,16" Background="#36393f"
                        IsVisible="{Binding SelectedConversation, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <StackPanel Spacing="8">
                        <!-- Formatting Toolbar -->
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <Button Background="Transparent"
                                    Padding="8,4"
                                    Cursor="Hand"
                                    ToolTip.Tip="Bold (wrap with **)"
                                    Click="OnBoldClick">
                                <TextBlock Text="B" Foreground="#b9bbbe" FontWeight="Bold" FontSize="14"/>
                            </Button>
                            <Button Background="Transparent"
                                    Padding="8,4"
                                    Cursor="Hand"
                                    ToolTip.Tip="Italic (wrap with *)"
                                    Click="OnItalicClick">
                                <TextBlock Text="I" Foreground="#b9bbbe" FontStyle="Italic" FontSize="14"/>
                            </Button>
                            <Button Background="Transparent"
                                    Padding="8,4"
                                    Cursor="Hand"
                                    ToolTip.Tip="Code (wrap with `)"
                                    Click="OnCodeClick">
                                <TextBlock Text="&lt;/&gt;" Foreground="#b9bbbe" FontFamily="Consolas,monospace" FontSize="12"/>
                            </Button>
                            <Border Width="1" Background="#42464d" Margin="4,2"/>
                            <TextBlock Text="Markdown supported"
                                       Foreground="#72767d"
                                       FontSize="11"
                                       VerticalAlignment="Center"
                                       Margin="4,0,0,0"/>
                        </StackPanel>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBox x:Name="MessageInputBox"
                                     Grid.Column="0"
                                     Text="{Binding MessageInput}"
                                     Watermark="{Binding SelectedConversation.Username, StringFormat='Message @{0}'}"
                                     Background="#40444b"
                                     Foreground="White"
                                     BorderThickness="0"
                                     CornerRadius="8"
                                     Padding="16,12"
                                     AcceptsReturn="True"
                                     TextWrapping="Wrap"
                                     MaxHeight="200"
                                     KeyDown="OnMessageKeyDown"/>

                            <Button Grid.Column="1"
                                    Command="{Binding SendMessageCommand}"
                                    Background="#5865f2"
                                    Foreground="White"
                                    Padding="16,10"
                                    Margin="8,0,0,0"
                                    CornerRadius="4">
                                <Panel>
                                    <TextBlock Text="Send" IsVisible="{Binding IsLoading, Converter={x:Static BoolConverters.Not}}"/>
                                    <TextBlock Text="..." IsVisible="{Binding IsLoading}"/>
                                </Panel>
                            </Button>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Messages List -->
                <ScrollViewer Margin="0,8" IsVisible="{Binding SelectedConversation, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <ItemsControl x:Name="MessagesList" ItemsSource="{Binding Messages}" Margin="16,0">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel>
                                    <!-- Date separator -->
                                    <Border Margin="0,16,0,8" Padding="0">
                                        <Border.IsVisible>
                                            <MultiBinding Converter="{x:Static converters:ShowDateSeparatorConverter.Instance}">
                                                <Binding />
                                                <Binding Path="DataContext.Messages" ElementName="MessagesList" />
                                            </MultiBinding>
                                        </Border.IsVisible>
                                        <Grid>
                                            <Separator Background="#42464d" Margin="0,8"/>
                                            <Border Background="#36393f" HorizontalAlignment="Center" Padding="8,2">
                                                <TextBlock Text="{Binding CreatedAt, Converter={x:Static converters:DateSeparatorTextConverter.Instance}}"
                                                           Foreground="#72767d"
                                                           FontSize="11"
                                                           FontWeight="SemiBold"/>
                                            </Border>
                                        </Grid>
                                    </Border>

                                    <!-- Unread separator -->
                                    <Border Margin="0,8" Padding="0">
                                        <Border.IsVisible>
                                            <MultiBinding Converter="{x:Static converters:IsFirstUnreadMessageConverter.Instance}">
                                                <Binding />
                                                <Binding Path="DataContext.FirstUnreadIndex" ElementName="MessagesList" />
                                                <Binding Path="DataContext.Messages" ElementName="MessagesList" />
                                            </MultiBinding>
                                        </Border.IsVisible>
                                        <Grid>
                                            <Separator Background="#ed4245" Margin="0,8"/>
                                            <Border Background="#36393f" HorizontalAlignment="Center" Padding="8,2">
                                                <TextBlock Text="NEW MESSAGES"
                                                           Foreground="#ed4245"
                                                           FontSize="11"
                                                           FontWeight="SemiBold"/>
                                            </Border>
                                        </Grid>
                                    </Border>

                                    <!-- Message -->
                                    <Border Margin="0,8" Padding="0">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Avatar -->
                                        <Border Grid.Column="0"
                                                Width="40" Height="40"
                                                CornerRadius="20"
                                                Background="#5865f2"
                                                VerticalAlignment="Top"
                                                Margin="0,0,12,0">
                                            <TextBlock Text="{Binding SenderUsername, Converter={x:Static converters:FirstCharConverter.Instance}}"
                                                       Foreground="White"
                                                       FontSize="16"
                                                       FontWeight="Bold"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"/>
                                        </Border>

                                        <!-- Message Content -->
                                        <StackPanel Grid.Column="1">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="{Binding SenderUsername}"
                                                           Foreground="White"
                                                           FontWeight="SemiBold"
                                                           FontSize="15"/>
                                                <TextBlock Text="{Binding CreatedAt, Converter={x:Static converters:RelativeTimestampConverter.Instance}}"
                                                           ToolTip.Tip="{Binding CreatedAt, Converter={x:Static converters:FullTimestampConverter.Instance}}"
                                                           Foreground="#72767d"
                                                           FontSize="12"
                                                           VerticalAlignment="Center"/>
                                            </StackPanel>
                                            <controls:MessageContentBlock Content="{Binding Content}"
                                                                        FontSize="15"
                                                                        Margin="0,4,0,0"/>
                                        </StackPanel>

                                        <!-- Edit/Delete Buttons (only show for own messages) -->
                                        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4" VerticalAlignment="Top">
                                            <Button Command="{Binding #MessagesList.DataContext.StartEditMessageCommand}"
                                                    CommandParameter="{Binding}"
                                                    Background="Transparent"
                                                    Padding="4"
                                                    Cursor="Hand"
                                                    ToolTip.Tip="Edit">
                                                <TextBlock Text="âœŽ" Foreground="#72767d" FontSize="12"/>
                                            </Button>
                                            <Button Command="{Binding #MessagesList.DataContext.DeleteMessageCommand}"
                                                    CommandParameter="{Binding}"
                                                    Background="Transparent"
                                                    Padding="4"
                                                    Cursor="Hand"
                                                    ToolTip.Tip="Delete">
                                                <TextBlock Text="ðŸ—‘" Foreground="#72767d" FontSize="12"/>
                                            </Button>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- Empty state when no conversation selected -->
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                            IsVisible="{Binding SelectedConversation, Converter={x:Static ObjectConverters.IsNull}}">
                    <TextBlock Text="âœ‰"
                               Foreground="#72767d"
                               FontSize="64"
                               HorizontalAlignment="Center"/>
                    <TextBlock Text="Select a conversation"
                               Foreground="#72767d"
                               FontSize="16"
                               Margin="0,16,0,0"
                               HorizontalAlignment="Center"/>
                </StackPanel>

                <!-- Message Edit Overlay -->
                <Border Background="#2f3136"
                        DockPanel.Dock="Bottom"
                        Padding="16"
                        IsVisible="{Binding EditingMessage, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <StackPanel Spacing="8">
                        <TextBlock Text="EDITING MESSAGE"
                                   Foreground="#72767d"
                                   FontSize="11"
                                   FontWeight="SemiBold"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0"
                                     x:Name="EditMessageInputBox"
                                     Text="{Binding EditingMessageContent}"
                                     Background="#40444b"
                                     Foreground="White"
                                     BorderThickness="0"
                                     CornerRadius="4"
                                     Padding="12,8"
                                     AcceptsReturn="True"
                                     TextWrapping="Wrap"
                                     MaxHeight="200"
                                     KeyDown="OnEditMessageKeyDown"/>
                            <Button Grid.Column="1"
                                    Command="{Binding CancelEditMessageCommand}"
                                    Background="Transparent"
                                    Foreground="#b9bbbe"
                                    Content="Cancel"
                                    Padding="12,8"
                                    Margin="8,0,0,0"
                                    Cursor="Hand"/>
                            <Button Grid.Column="2"
                                    Command="{Binding SaveMessageEditCommand}"
                                    Background="#5865f2"
                                    Foreground="White"
                                    Padding="12,8"
                                    Margin="8,0,0,0"
                                    CornerRadius="4"
                                    Cursor="Hand">
                                <Panel>
                                    <TextBlock Text="Save" IsVisible="{Binding IsLoading, Converter={x:Static BoolConverters.Not}}"/>
                                    <TextBlock Text="..." IsVisible="{Binding IsLoading}"/>
                                </Panel>
                            </Button>
                        </Grid>
                    </StackPanel>
                </Border>
            </DockPanel>
        </Border>
    </Grid>
</UserControl>
