<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Snacka.Client.ViewModels"
             x:Class="Snacka.Client.Views.SharePortPickerView"
             x:DataType="vm:SharePortPickerViewModel"
             Width="320">

    <Border Background="#2f3136"
            CornerRadius="8"
            Padding="16"
            BorderThickness="1"
            BorderBrush="#202225">
        <StackPanel Spacing="12">
            <!-- Header -->
            <TextBlock Text="Share a local port"
                       Foreground="#dcddde"
                       FontSize="16"
                       FontWeight="SemiBold"/>

            <!-- Active Shares Section (shown when user has active shares) -->
            <StackPanel Spacing="4"
                        IsVisible="{Binding HasActiveShares}">
                <TextBlock Text="Active shares"
                           Foreground="#72767d"
                           FontSize="12"
                           FontWeight="SemiBold"/>
                <ItemsControl ItemsSource="{Binding ActiveShares}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="#292b2f"
                                    CornerRadius="4"
                                    Padding="8"
                                    Margin="0,2">
                                <DockPanel>
                                    <Button Content="Stop"
                                            DockPanel.Dock="Right"
                                            Command="{Binding $parent[ItemsControl].((vm:SharePortPickerViewModel)DataContext).StopShareCommand}"
                                            CommandParameter="{Binding TunnelId}"
                                            Background="#ed4245"
                                            Foreground="White"
                                            CornerRadius="4"
                                            Padding="8,4"
                                            Cursor="Hand"
                                            FontSize="11"/>
                                    <TextBlock Text="{Binding LocalPort, StringFormat='Port {0}'}"
                                               Foreground="#dcddde"
                                               FontSize="13"
                                               VerticalAlignment="Center"/>
                                </DockPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>

            <Border Height="1" Background="#40444b"
                    IsVisible="{Binding HasActiveShares}"/>

            <!-- Detected Ports Section -->
            <StackPanel Spacing="4">
                <DockPanel>
                    <Button Content="Scan"
                            DockPanel.Dock="Right"
                            Command="{Binding RefreshDetectionCommand}"
                            Background="Transparent"
                            Foreground="#72767d"
                            Padding="4,2"
                            Cursor="Hand"
                            FontSize="11"/>
                    <TextBlock Text="Detected servers"
                               Foreground="#72767d"
                               FontSize="12"
                               FontWeight="SemiBold"
                               VerticalAlignment="Center"/>
                </DockPanel>

                <TextBlock Text="Scanning..."
                           Foreground="#faa61a"
                           FontSize="12"
                           IsVisible="{Binding IsScanning}"/>

                <TextBlock Text="No dev servers detected"
                           Foreground="#72767d"
                           FontSize="12"
                           FontStyle="Italic"
                           IsVisible="{Binding !DetectedPorts.Count}"/>

                <ItemsControl ItemsSource="{Binding DetectedPorts}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Button Background="#292b2f"
                                    CornerRadius="4"
                                    Padding="8"
                                    Margin="0,2"
                                    Cursor="Hand"
                                    HorizontalContentAlignment="Stretch"
                                    HorizontalAlignment="Stretch"
                                    Click="OnDetectedPortClick"
                                    Tag="{Binding}">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <Ellipse Width="8" Height="8" Fill="#3ba55c" VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding Port, StringFormat='localhost:{0}'}"
                                               Foreground="#dcddde"
                                               FontSize="13"
                                               VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding ServerType, StringFormat='({0})'}"
                                               Foreground="#72767d"
                                               FontSize="12"
                                               VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>

            <Border Height="1" Background="#40444b"/>

            <!-- Manual Entry -->
            <StackPanel Spacing="4">
                <TextBlock Text="Or enter manually"
                           Foreground="#72767d"
                           FontSize="12"
                           FontWeight="SemiBold"/>
                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto" HorizontalAlignment="Stretch">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="8"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <TextBox Grid.Column="0"
                             Text="{Binding ManualPortText}"
                             Watermark="Port"
                             FontSize="13"/>
                    <TextBox Grid.Column="2"
                             Text="{Binding Label}"
                             Watermark="Label (optional)"
                             FontSize="13"/>
                </Grid>
            </StackPanel>

            <!-- Action Buttons -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
                <Button Content="Cancel"
                        Command="{Binding CloseCommand}"
                        Background="Transparent"
                        Foreground="#dcddde"
                        Padding="12,8"
                        CornerRadius="4"
                        Cursor="Hand"/>
                <Button Content="Share"
                        Command="{Binding ShareCommand}"
                        Background="#5865f2"
                        Foreground="White"
                        Padding="12,8"
                        CornerRadius="4"
                        Cursor="Hand"
                        FontWeight="SemiBold"/>
            </StackPanel>
        </StackPanel>
    </Border>
</UserControl>
