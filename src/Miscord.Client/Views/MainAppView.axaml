<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Miscord.Client.ViewModels"
             xmlns:controls="using:Miscord.Client.Controls"
             xmlns:conv="using:Miscord.Client.Converters"
             xmlns:services="using:Miscord.Client.Services"
             xmlns:views="using:Miscord.Client.Views"
             x:Class="Miscord.Client.Views.MainAppView"
             x:DataType="vm:MainAppViewModel"
             x:CompileBindings="False">
    <UserControl.Resources>
        <conv:ColorToBorderConverter x:Key="ColorToBorderConverter"/>
    </UserControl.Resources>
    <Grid Background="#202225">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="72"/>
            <ColumnDefinition Width="240"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="240"/>
        </Grid.ColumnDefinitions>

        <!-- Community List (Left Sidebar) -->
        <controls:CommunityListView Grid.Column="0"
                                    Communities="{Binding Communities}"
                                    IsLoading="{Binding IsLoading}"
                                    SelectCommunityCommand="{Binding SelectCommunityCommand}"
                                    CreateCommunityCommand="{Binding CreateCommunityCommand}"
                                    OpenDMsCommand="{Binding OpenDMsCommand}"/>

        <!-- Channel List (Second Column) -->
        <Border Grid.Column="1" Background="#2f3136">
            <DockPanel>
                <!-- Community Name Header -->
                <Border DockPanel.Dock="Top" Background="#2f3136" Padding="16,12" BorderThickness="0,0,0,1" BorderBrush="#202225">
                    <TextBlock Text="{Binding SelectedCommunity.Name, FallbackValue='Select a Community'}"
                               Foreground="White"
                               FontWeight="SemiBold"
                               FontSize="16"/>
                </Border>

                <!-- User Panel at Bottom (always visible, docked first to be at very bottom) -->
                <controls:UserPanelView DockPanel.Dock="Bottom"
                                        Username="{Binding Username}"
                                        IsSpeaking="{Binding IsSpeaking}"
                                        IsMuted="{Binding IsMuted}"
                                        IsDeafened="{Binding IsDeafened}"
                                        ToggleMuteCommand="{Binding ToggleMuteCommand}"
                                        ToggleDeafenCommand="{Binding ToggleDeafenCommand}"
                                        OpenSettingsCommand="{Binding OpenSettingsCommand}"
                                        AudioDeviceButtonClicked="OnUserPanelAudioDeviceButtonClick"/>

                <!-- Voice Connected Panel (shows when in voice channel, above user panel) -->
                <controls:VoiceConnectedPanelView DockPanel.Dock="Bottom"
                                                  IsInVoiceChannel="{Binding IsInVoiceChannel}"
                                                  IsVoiceConnected="{Binding IsVoiceConnected}"
                                                  IsVoiceConnecting="{Binding IsVoiceConnecting}"
                                                  VoiceConnectionStatusText="{Binding VoiceConnectionStatusText}"
                                                  CurrentVoiceChannel="{Binding CurrentVoiceChannel}"
                                                  IsCameraOn="{Binding IsCameraOn}"
                                                  IsScreenSharing="{Binding IsScreenSharing}"
                                                  IsDrawingAllowedForViewers="{Binding IsDrawingAllowedForViewers, Mode=TwoWay}"
                                                  ToggleCameraCommand="{Binding ToggleCameraCommand}"
                                                  ToggleScreenShareCommand="{Binding ToggleScreenShareCommand}"
                                                  LeaveVoiceChannelCommand="{Binding LeaveVoiceChannelCommand}"/>

                <!-- Channel List -->
                <controls:ChannelListView Margin="8,8,0,0"
                                          TextChannels="{Binding TextChannels}"
                                          VoiceChannels="{Binding VoiceChannelViewModels}"
                                          CurrentVoiceChannel="{Binding CurrentVoiceChannel}"
                                          CanManageChannels="{Binding CanManageChannels}"
                                          CanManageVoice="{Binding CanManageVoice}"
                                          IsLoading="{Binding IsLoading}"
                                          EditingChannel="{Binding EditingChannel}"
                                          EditingChannelName="{Binding EditingChannelName, Mode=TwoWay}"
                                          CreateChannelCommand="{Binding CreateChannelCommand}"
                                          CreateVoiceChannelCommand="{Binding CreateVoiceChannelCommand}"
                                          SelectChannelCommand="{Binding SelectChannelCommand}"
                                          StartEditChannelCommand="{Binding StartEditChannelCommand}"
                                          SaveChannelNameCommand="{Binding SaveChannelNameCommand}"
                                          CancelEditChannelCommand="{Binding CancelEditChannelCommand}"
                                          ServerMuteUserCommand="{Binding ServerMuteUserCommand}"
                                          ServerDeafenUserCommand="{Binding ServerDeafenUserCommand}"
                                          VoiceChannelClicked="OnVoiceChannelClicked"
                                          VoiceChannelViewRequested="OnVoiceChannelViewRequested"/>
            </DockPanel>
        </Border>

        <!-- Main Content Area (Chat, Voice Channel, or DM) -->
        <Grid Grid.Column="2">
            <!-- DM Content (shown when viewing DM conversation) -->
            <controls:DMContentView IsVisible="{Binding IsViewingDM}"
                                    DMRecipientName="{Binding DMRecipientName}"
                                    IsDMTyping="{Binding IsDMTyping}"
                                    DMTypingIndicatorText="{Binding DMTypingIndicatorText}"
                                    DMMessageInput="{Binding DMMessageInput, Mode=TwoWay}"
                                    DMMessages="{Binding DMMessages}"
                                    EditingDMMessage="{Binding EditingDMMessage}"
                                    EditingDMMessageContent="{Binding EditingDMMessageContent, Mode=TwoWay}"
                                    IsLoading="{Binding IsLoading}"
                                    CloseDMCommand="{Binding CloseDMCommand}"
                                    SendDMMessageCommand="{Binding SendDMMessageCommand}"
                                    StartEditDMMessageCommand="{Binding StartEditDMMessageCommand}"
                                    DeleteDMMessageCommand="{Binding DeleteDMMessageCommand}"
                                    CancelEditDMMessageCommand="{Binding CancelEditDMMessageCommand}"
                                    SaveDMMessageEditCommand="{Binding SaveDMMessageEditCommand}"/>

            <!-- Voice Channel Content (shown when viewing voice channel, but not DM) -->
            <controls:VoiceChannelContentView SelectedVoiceChannel="{Binding SelectedVoiceChannelForViewing}"
                                              ShowAudioDeviceWarning="{Binding ShowAudioDeviceWarning}"
                                              VoiceChannelContent="{Binding VoiceChannelContent}"
                                              OpenSettingsCommand="{Binding OpenSettingsCommand}"
                                              WatchScreenShareRequested="OnVoiceChannelWatchScreenShare"
                                              FullscreenRequested="OnVoiceChannelFullscreen"
                                              VideoTileDoubleTapped="OnVoiceChannelVideoTileDoubleTapped">
                <controls:VoiceChannelContentView.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                        <Binding Path="IsViewingVoiceChannel"/>
                        <Binding Path="IsViewingDM" Converter="{x:Static BoolConverters.Not}"/>
                    </MultiBinding>
                </controls:VoiceChannelContentView.IsVisible>
            </controls:VoiceChannelContentView>

            <!-- Chat Area (shown when not viewing voice channel or DM) -->
            <Border Background="#36393f">
                <Border.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                        <Binding Path="IsViewingVoiceChannel" Converter="{x:Static BoolConverters.Not}"/>
                        <Binding Path="IsViewingDM" Converter="{x:Static BoolConverters.Not}"/>
                    </MultiBinding>
                </Border.IsVisible>
                <DockPanel>
                    <!-- Channel Header -->
                    <Border DockPanel.Dock="Top" Background="#36393f" Padding="16,12" BorderThickness="0,0,0,1" BorderBrush="#202225">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="#"
                                       Foreground="#72767d"
                                       FontSize="22"
                                       VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding SelectedChannel.Name, FallbackValue='general'}"
                                       Foreground="White"
                                       FontWeight="SemiBold"
                                       FontSize="16"
                                       VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding SelectedChannel.Topic}"
                                       Foreground="#72767d"
                                       FontSize="13"
                                       VerticalAlignment="Center"
                                       Margin="8,0,0,0"
                                       IsVisible="{Binding SelectedChannel.Topic, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                            <!-- Pinned Messages Button -->
                            <Button Classes="msg-action-btn"
                                    Command="{Binding ShowPinnedMessagesCommand}"
                                    ToolTip.Tip="Pinned Messages"
                                    Margin="8,0,0,0"
                                    VerticalAlignment="Center">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <TextBlock Text="ðŸ“Œ" FontSize="14"/>
                                    <TextBlock Text="{Binding PinnedCount}"
                                               Foreground="#72767d"
                                               FontSize="12"
                                               VerticalAlignment="Center"
                                               IsVisible="{Binding PinnedCount, Converter={x:Static conv:IntGreaterThanZeroConverter.Instance}}"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Border>

                <!-- Message Input -->
                <Border DockPanel.Dock="Bottom" Padding="16,8,16,16" Background="#36393f">
                    <StackPanel Spacing="8">
                        <!-- Formatting Toolbar -->
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <Button Background="Transparent"
                                    Padding="8,4"
                                    Cursor="Hand"
                                    ToolTip.Tip="Bold (wrap with **)"
                                    Click="OnBoldClick">
                                <TextBlock Text="B" Foreground="#b9bbbe" FontWeight="Bold" FontSize="14"/>
                            </Button>
                            <Button Background="Transparent"
                                    Padding="8,4"
                                    Cursor="Hand"
                                    ToolTip.Tip="Italic (wrap with *)"
                                    Click="OnItalicClick">
                                <TextBlock Text="I" Foreground="#b9bbbe" FontStyle="Italic" FontSize="14"/>
                            </Button>
                            <Button Background="Transparent"
                                    Padding="8,4"
                                    Cursor="Hand"
                                    ToolTip.Tip="Code (wrap with `)"
                                    Click="OnCodeClick">
                                <TextBlock Text="&lt;/&gt;" Foreground="#b9bbbe" FontFamily="Consolas,monospace" FontSize="12"/>
                            </Button>
                            <Border Width="1" Background="#42464d" Margin="4,2"/>
                            <TextBlock Text="Markdown supported"
                                       Foreground="#72767d"
                                       FontSize="11"
                                       VerticalAlignment="Center"
                                       Margin="4,0,0,0"/>
                        </StackPanel>

                        <!-- Reply Preview Banner -->
                        <Border Background="#2f3136"
                                CornerRadius="4"
                                Padding="12,8"
                                Margin="0,0,0,8"
                                IsVisible="{Binding IsReplying}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="â†©" Foreground="#5865f2" FontSize="14" VerticalAlignment="Center"/>
                                    <TextBlock Text="Replying to" Foreground="#72767d" FontSize="13" VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding ReplyingToMessage.AuthorUsername}"
                                               Foreground="#5865f2"
                                               FontSize="13"
                                               FontWeight="SemiBold"
                                               VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding ReplyingToMessage.Content}"
                                               Foreground="#72767d"
                                               FontSize="13"
                                               TextTrimming="CharacterEllipsis"
                                               MaxWidth="350"
                                               VerticalAlignment="Center"/>
                                </StackPanel>
                                <Button Grid.Column="1"
                                        Command="{Binding CancelReplyCommand}"
                                        Background="Transparent"
                                        Padding="4"
                                        Cursor="Hand"
                                        ToolTip.Tip="Cancel Reply">
                                    <TextBlock Text="âœ•" Foreground="#72767d" FontSize="14"/>
                                </Button>
                            </Grid>
                        </Border>

                        <!-- Typing Indicator -->
                        <TextBlock Text="{Binding TypingIndicatorText}"
                                   IsVisible="{Binding IsAnyoneTyping}"
                                   Foreground="#72767d"
                                   FontSize="12"
                                   FontStyle="Italic"
                                   Margin="0,0,0,4"/>

                        <!-- Pending Attachments Preview -->
                        <Border Background="#2f3136"
                                CornerRadius="4"
                                Padding="8"
                                Margin="0,0,0,8"
                                IsVisible="{Binding HasPendingAttachments}">
                            <DockPanel>
                                <TextBlock DockPanel.Dock="Top"
                                           Text="Attachments"
                                           Foreground="#72767d"
                                           FontSize="11"
                                           FontWeight="SemiBold"
                                           Margin="0,0,0,4"/>
                                <ItemsControl x:Name="PendingAttachmentsList" ItemsSource="{Binding PendingAttachments}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel Orientation="Horizontal"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#40444b"
                                                    CornerRadius="4"
                                                    Padding="8,4"
                                                    Margin="0,0,8,4">
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <TextBlock Text="{Binding FileName}"
                                                               Foreground="#dcddde"
                                                               FontSize="12"
                                                               MaxWidth="200"
                                                               TextTrimming="CharacterEllipsis"
                                                               VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding FormattedSize}"
                                                               Foreground="#72767d"
                                                               FontSize="11"
                                                               VerticalAlignment="Center"/>
                                                    <Button Background="Transparent"
                                                            Padding="4,2"
                                                            Cursor="Hand"
                                                            ToolTip.Tip="Remove"
                                                            Click="OnRemovePendingAttachment"
                                                            Tag="{Binding}">
                                                        <TextBlock Text="âœ•" Foreground="#72767d" FontSize="10"/>
                                                    </Button>
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </DockPanel>
                        </Border>

                        <!-- Mention Autocomplete Popup -->
                        <Border Background="#2f3136"
                                CornerRadius="4"
                                Padding="4"
                                Margin="0,0,0,8"
                                IsVisible="{Binding IsMentionPopupOpen}">
                            <ItemsControl x:Name="MentionSuggestionsList" ItemsSource="{Binding MentionSuggestions}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border x:Name="MentionItemBorder"
                                                Classes="member-item"
                                                Padding="8,6"
                                                CornerRadius="4"
                                                Cursor="Hand"
                                                PointerPressed="MentionSuggestion_PointerPressed">
                                            <Border.Background>
                                                <MultiBinding Converter="{x:Static conv:MentionSelectedBackgroundConverter.Instance}">
                                                    <Binding />
                                                    <Binding Path="DataContext.MentionSuggestions" ElementName="MentionSuggestionsList" />
                                                    <Binding Path="DataContext.SelectedMentionIndex" ElementName="MentionSuggestionsList" />
                                                </MultiBinding>
                                            </Border.Background>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>

                                                <!-- Avatar -->
                                                <Border Grid.Column="0"
                                                        Width="28" Height="28"
                                                        CornerRadius="14"
                                                        Background="#5865f2"
                                                        Margin="0,0,8,0">
                                                    <TextBlock Text="{Binding Username[0]}"
                                                               Foreground="White"
                                                               FontSize="12"
                                                               FontWeight="Bold"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"/>
                                                </Border>

                                                <!-- Username -->
                                                <TextBlock Grid.Column="1"
                                                           Text="{Binding Username}"
                                                           Foreground="#dcddde"
                                                           FontSize="14"
                                                           VerticalAlignment="Center"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Border>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Attach Button -->
                            <Button Grid.Column="0"
                                    Background="Transparent"
                                    Padding="12,10"
                                    Margin="0,0,4,0"
                                    CornerRadius="4"
                                    Cursor="Hand"
                                    ToolTip.Tip="Attach files"
                                    Click="OnAttachButtonClick">
                                <TextBlock Text="ðŸ“Ž" FontSize="18" Foreground="#b9bbbe"/>
                            </Button>

                            <!-- GIF Button -->
                            <Button x:Name="GifButton"
                                    Grid.Column="1"
                                    Background="Transparent"
                                    Padding="8,10"
                                    Margin="0,0,4,0"
                                    CornerRadius="4"
                                    Cursor="Hand"
                                    ToolTip.Tip="Send a GIF"
                                    IsVisible="{Binding IsGifsEnabled}"
                                    Click="OnGifButtonClick">
                                <TextBlock Text="GIF" FontSize="11" FontWeight="Bold" Foreground="#b9bbbe"/>
                            </Button>

                            <TextBox x:Name="MessageInputBox"
                                     Grid.Column="2"
                                     Text="{Binding MessageInput}"
                                     Watermark="{Binding SelectedChannel.Name, StringFormat='Message #{0}'}"
                                     Background="#40444b"
                                     Foreground="White"
                                     BorderThickness="0"
                                     CornerRadius="8"
                                     Padding="16,12"
                                     AcceptsReturn="True"
                                     TextWrapping="Wrap"
                                     MaxHeight="200"
                                     DragDrop.AllowDrop="True"/>

                            <Button Grid.Column="3"
                                    Command="{Binding SendMessageCommand}"
                                    Background="#5865f2"
                                    Foreground="White"
                                    Padding="16,10"
                                    Margin="8,0,0,0"
                                    CornerRadius="4">
                                <Panel>
                                    <TextBlock Text="Send" IsVisible="{Binding IsLoading, Converter={x:Static BoolConverters.Not}}"/>
                                    <TextBlock Text="..." IsVisible="{Binding IsLoading}"/>
                                </Panel>
                            </Button>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Messages List -->
                <ScrollViewer x:Name="MessagesScrollViewer" Margin="0,8" HorizontalScrollBarVisibility="Disabled">
                    <ItemsControl x:Name="MessagesList"
                                  ItemsSource="{Binding Messages}"
                                  Margin="16,0"
                                  HorizontalAlignment="Stretch"
                                  Width="{Binding $parent[ScrollViewer].Viewport.Width}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <controls:MessageItemView
                                    Message="{Binding}"
                                    AuthorUsername="{Binding AuthorUsername}"
                                    MessageContent="{Binding Content}"
                                    CreatedAt="{Binding CreatedAt}"
                                    IsEdited="{Binding IsEdited}"
                                    ReplyTo="{Binding ReplyTo}"
                                    Reactions="{Binding Reactions}"
                                    Attachments="{Binding Attachments}"
                                    IsPinned="{Binding IsPinned}"
                                    ReplyCount="{Binding ReplyCount}"
                                    BaseUrl="{Binding #MessagesList.DataContext.BaseUrl}"
                                    TogglePinCommand="{Binding #MessagesList.DataContext.TogglePinCommand}"
                                    ReplyToMessageCommand="{Binding #MessagesList.DataContext.ReplyToMessageCommand}"
                                    StartEditMessageCommand="{Binding #MessagesList.DataContext.StartEditMessageCommand}"
                                    DeleteMessageCommand="{Binding #MessagesList.DataContext.DeleteMessageCommand}"
                                    ShowThreadIndicator="True"
                                    ShowStartThreadButton="True"
                                    ShowPinButton="True"
                                    ShowReplyButton="True"
                                    ShowReactions="True"
                                    ShowAttachments="True"
                                    AddReactionRequested="OnMessageAddReactionRequested"
                                    StartThreadRequested="OnMessageStartThreadRequested"
                                    ViewThreadRequested="OnMessageViewThreadRequested"
                                    ReactionToggleRequested="OnMessageReactionToggleRequested"
                                    ImageClicked="OnAttachmentImageClicked">
                                    <controls:MessageItemView.ShowDateSeparator>
                                        <MultiBinding Converter="{x:Static conv:ShowDateSeparatorConverter.Instance}">
                                            <Binding />
                                            <Binding Path="DataContext.Messages" ElementName="MessagesList" />
                                        </MultiBinding>
                                    </controls:MessageItemView.ShowDateSeparator>
                                </controls:MessageItemView>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- Message Edit Overlay -->
                <Border Background="#2f3136"
                        DockPanel.Dock="Bottom"
                        Padding="16"
                        IsVisible="{Binding EditingMessage, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <StackPanel Spacing="8">
                        <TextBlock Text="EDITING MESSAGE"
                                   Foreground="#72767d"
                                   FontSize="11"
                                   FontWeight="SemiBold"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0"
                                     x:Name="EditMessageInputBox"
                                     Text="{Binding EditingMessageContent}"
                                     Background="#40444b"
                                     Foreground="White"
                                     BorderThickness="0"
                                     CornerRadius="4"
                                     Padding="12,8"
                                     AcceptsReturn="True"
                                     TextWrapping="Wrap"
                                     MaxHeight="200"/>
                            <Button Grid.Column="1"
                                    Command="{Binding CancelEditMessageCommand}"
                                    Background="Transparent"
                                    Foreground="#b9bbbe"
                                    Content="Cancel"
                                    Padding="12,8"
                                    Margin="8,0,0,0"
                                    Cursor="Hand"/>
                            <Button Grid.Column="2"
                                    Command="{Binding SaveMessageEditCommand}"
                                    Background="#5865f2"
                                    Foreground="White"
                                    Padding="12,8"
                                    Margin="8,0,0,0"
                                    CornerRadius="4"
                                    Cursor="Hand">
                                <Panel>
                                    <TextBlock Text="Save" IsVisible="{Binding IsLoading, Converter={x:Static BoolConverters.Not}}"/>
                                    <TextBlock Text="..." IsVisible="{Binding IsLoading}"/>
                                </Panel>
                            </Button>
                        </Grid>
                    </StackPanel>
                </Border>
            </DockPanel>
        </Border>
        </Grid>

        <!-- Right Sidebar (Members List - always visible) -->
        <controls:MembersListView Grid.Column="3"
                                  Members="{Binding SortedMembers}"
                                  CurrentUserId="{Binding UserId}"
                                  CanManageMembers="{Binding CanManageMembers}"
                                  ChangeMyNicknameCommand="{Binding ChangeMyNicknameCommand}"
                                  StartDMCommand="{Binding StartDMCommand}"
                                  ChangeMemberNicknameCommand="{Binding ChangeMemberNicknameCommand}"
                                  PromoteToAdminCommand="{Binding PromoteToAdminCommand}"
                                  DemoteToMemberCommand="{Binding DemoteToMemberCommand}"
                                  TransferOwnershipCommand="{Binding TransferOwnershipCommand}"
                                  MemberClicked="OnMemberClicked"/>

        <!-- Thread Panel Overlay (visible when thread IS open) -->
        <Border Grid.Column="2" Grid.ColumnSpan="2"
                HorizontalAlignment="Right"
                Width="{Binding ThreadPanelWidth}"
                IsVisible="{Binding CurrentThread, Converter={x:Static ObjectConverters.IsNotNull}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="4"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Resize Handle -->
                <Border Grid.Column="0"
                        Background="#202225"
                        Cursor="SizeWestEast"
                        PointerPressed="ThreadPanelResizeHandle_PointerPressed"
                        PointerMoved="ThreadPanelResizeHandle_PointerMoved"
                        PointerReleased="ThreadPanelResizeHandle_PointerReleased"/>

                <!-- Thread Content -->
                <controls:ThreadPanelView Grid.Column="1"
                                          DataContext="{Binding CurrentThread}"
                                          BaseUrl="{Binding $parent[UserControl].DataContext.BaseUrl}"
                                          StartEditMessageCommand="{Binding $parent[UserControl].DataContext.StartEditMessageCommand}"
                                          DeleteMessageCommand="{Binding $parent[UserControl].DataContext.DeleteMessageCommand}"
                                          AddReactionRequested="OnThreadMessageAddReactionRequested"
                                          ReactionToggleRequested="OnThreadMessageReactionToggleRequested"
                                          ImageClicked="OnAttachmentImageClicked"/>
            </Grid>
        </Border>

        <!-- Screen Share Picker Overlay -->
        <Border Grid.ColumnSpan="4"
                Background="#80000000"
                IsVisible="{Binding IsScreenSharePickerOpen}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <views:ScreenSharePickerView DataContext="{Binding ScreenSharePicker}"
                                          HorizontalAlignment="Center"
                                          VerticalAlignment="Center"/>
        </Border>

        <!-- Video Fullscreen Overlay -->
        <Border Grid.ColumnSpan="4"
                Background="#FF000000"
                IsVisible="{Binding IsVideoFullscreen}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <Grid>
                <!-- Video fills the space -->
                <Image x:Name="FullscreenVideoImage"
                       Source="{Binding FullscreenStream.VideoBitmap}"
                       Stretch="Uniform"
                       HorizontalAlignment="Stretch"
                       VerticalAlignment="Stretch"/>

                <!-- Drawing Canvas Overlay (transparent, captures drawing input when enabled) -->
                <Canvas x:Name="AnnotationCanvas"
                        Background="Transparent"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Stretch"
                        IsHitTestVisible="{Binding IsAnnotationEnabled}"
                        PointerPressed="OnAnnotationCanvasPointerPressed"
                        PointerMoved="OnAnnotationCanvasPointerMoved"
                        PointerReleased="OnAnnotationCanvasPointerReleased"/>

                <!-- Drawing Toolbar - bottom center (only visible when host allows drawing) -->
                <Border VerticalAlignment="Bottom"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,80"
                        Background="#E0202020"
                        CornerRadius="8"
                        Padding="12,8"
                        IsVisible="{Binding IsDrawingAllowedByHost}">
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <!-- Draw mode toggle - only visible when host allows drawing -->
                        <ToggleButton IsChecked="{Binding IsAnnotationEnabled}"
                                      Padding="12,6"
                                      Background="#40FFFFFF"
                                      Foreground="White"
                                      CornerRadius="4">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="âœï¸" VerticalAlignment="Center"/>
                                <TextBlock Text="Draw" VerticalAlignment="Center"/>
                            </StackPanel>
                        </ToggleButton>

                        <!-- Color separator -->
                        <Border Width="1" Background="#40FFFFFF" Margin="4,0"/>

                        <!-- Color buttons -->
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <Button Width="28" Height="28" Padding="0" CornerRadius="4"
                                    Background="#FF0000" BorderThickness="2"
                                    BorderBrush="{Binding AnnotationColor, Converter={StaticResource ColorToBorderConverter}, ConverterParameter=#FF0000}"
                                    Click="OnAnnotationColorClick" Tag="#FF0000"/>
                            <Button Width="28" Height="28" Padding="0" CornerRadius="4"
                                    Background="#00FF00" BorderThickness="2"
                                    BorderBrush="{Binding AnnotationColor, Converter={StaticResource ColorToBorderConverter}, ConverterParameter=#00FF00}"
                                    Click="OnAnnotationColorClick" Tag="#00FF00"/>
                            <Button Width="28" Height="28" Padding="0" CornerRadius="4"
                                    Background="#0080FF" BorderThickness="2"
                                    BorderBrush="{Binding AnnotationColor, Converter={StaticResource ColorToBorderConverter}, ConverterParameter=#0080FF}"
                                    Click="OnAnnotationColorClick" Tag="#0080FF"/>
                            <Button Width="28" Height="28" Padding="0" CornerRadius="4"
                                    Background="#FFFF00" BorderThickness="2"
                                    BorderBrush="{Binding AnnotationColor, Converter={StaticResource ColorToBorderConverter}, ConverterParameter=#FFFF00}"
                                    Click="OnAnnotationColorClick" Tag="#FFFF00"/>
                            <Button Width="28" Height="28" Padding="0" CornerRadius="4"
                                    Background="#FFFFFF" BorderThickness="2"
                                    BorderBrush="{Binding AnnotationColor, Converter={StaticResource ColorToBorderConverter}, ConverterParameter=#FFFFFF}"
                                    Click="OnAnnotationColorClick" Tag="#FFFFFF"/>
                        </StackPanel>

                        <!-- Clear separator (only show when drawing allowed) -->
                        <Border Width="1" Background="#40FFFFFF" Margin="4,0"
                                IsVisible="{Binding IsDrawingAllowedByHost}"/>

                        <!-- Clear button (only show when drawing allowed) -->
                        <Button Padding="12,6"
                                Background="#40FFFFFF"
                                Foreground="White"
                                CornerRadius="4"
                                Click="OnClearAnnotationsClick"
                                IsVisible="{Binding IsDrawingAllowedByHost}">
                            <TextBlock Text="Clear"/>
                        </Button>
                    </StackPanel>
                </Border>

                <!-- Close button - top right -->
                <Button VerticalAlignment="Top"
                        HorizontalAlignment="Right"
                        Margin="16"
                        Padding="8,4"
                        Background="#60000000"
                        BorderThickness="0"
                        CornerRadius="4"
                        Cursor="Hand"
                        Click="OnCloseFullscreenClick">
                    <TextBlock Text="âœ•" Foreground="White" FontSize="20"/>
                </Button>

                <!-- Username label - bottom left -->
                <Border VerticalAlignment="Bottom"
                        HorizontalAlignment="Left"
                        Background="#80000000"
                        Padding="12,6"
                        Margin="16"
                        CornerRadius="4">
                    <TextBlock Text="{Binding FullscreenStream.Username}"
                               Foreground="White"
                               FontSize="14"/>
                </Border>
            </Grid>
        </Border>

        <!-- Nickname Edit Overlay -->
        <controls:NicknameEditOverlay Grid.ColumnSpan="4"
                                      IsVisibleOverlay="{Binding IsEditingNickname}"
                                      IsEditingMyNickname="{Binding IsEditingMyNickname}"
                                      EditingNickname="{Binding EditingNickname, Mode=TwoWay}"
                                      IsLoading="{Binding IsLoading}"
                                      SaveNicknameCommand="{Binding SaveNicknameCommand}"
                                      CancelNicknameEditCommand="{Binding CancelNicknameEditCommand}"/>

        <!-- Emoji Picker Popup -->
        <Popup x:Name="EmojiPickerPopup"
               IsLightDismissEnabled="True"
               Placement="Top"
               PlacementGravity="Top">
            <controls:EmojiPickerContent EmojiSelected="OnEmojiPickerEmojiSelected"/>
        </Popup>

        <!-- GIF Picker Popup -->
        <Popup x:Name="GifPickerPopup"
               IsLightDismissEnabled="True"
               Placement="Top"
               PlacementGravity="Top">
            <controls:GifPickerContent x:Name="GifPickerContent"
                                       GifSearchQuery="{Binding GifSearchQuery, Mode=TwoWay}"
                                       IsLoadingGifs="{Binding IsLoadingGifs}"
                                       GifResults="{Binding GifResults}"
                                       SearchGifsCommand="{Binding SearchGifsCommand}"
                                       GifSelected="OnGifPickerGifSelected"/>
        </Popup>

        <!-- Audio Device Popup -->
        <Popup x:Name="AudioDevicePopup"
               IsOpen="{Binding IsAudioDevicePopupOpen}"
               IsLightDismissEnabled="True"
               Placement="Bottom"
               PlacementTarget="{Binding $parent[Grid]}">
            <controls:AudioDeviceContent InputDevices="{Binding InputDevices}"
                                         SelectedInputDeviceItem="{Binding SelectedInputDeviceItem, Mode=TwoWay}"
                                         OutputDevices="{Binding OutputDevices}"
                                         SelectedOutputDeviceItem="{Binding SelectedOutputDeviceItem, Mode=TwoWay}"
                                         InputLevel="{Binding InputLevel}"
                                         PushToTalkEnabled="{Binding PushToTalkEnabled, Mode=TwoWay}"
                                         VoiceModeDescription="{Binding VoiceModeDescription}"
                                         RefreshDevicesRequested="OnAudioDeviceRefreshRequested"/>
        </Popup>

        <!-- Pinned Messages Popup -->
        <Popup IsOpen="{Binding IsPinnedPopupOpen}"
               IsLightDismissEnabled="True"
               Placement="Center"
               PlacementTarget="{Binding $parent[Grid]}">
            <controls:PinnedMessagesContent PinnedMessages="{Binding PinnedMessages}"
                                            ClosePinnedPopupCommand="{Binding ClosePinnedPopupCommand}"
                                            TogglePinCommand="{Binding TogglePinCommand}"/>
        </Popup>

        <!-- Image Lightbox Overlay -->
        <controls:ImageLightbox Grid.ColumnSpan="4"
                                Attachment="{Binding LightboxImage}"
                                BaseUrl="{Binding BaseUrl}"
                                CloseRequested="OnLightboxCloseRequested"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"/>
    </Grid>
</UserControl>
