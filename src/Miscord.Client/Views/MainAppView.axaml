<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Miscord.Client.ViewModels"
             xmlns:controls="using:Miscord.Client.Controls"
             xmlns:conv="using:Miscord.Client.Converters"
             xmlns:services="using:Miscord.Client.Services"
             xmlns:views="using:Miscord.Client.Views"
             x:Class="Miscord.Client.Views.MainAppView"
             x:DataType="vm:MainAppViewModel"
             x:CompileBindings="False">
    <UserControl.Resources>
        <conv:ColorToBorderConverter x:Key="ColorToBorderConverter"/>
    </UserControl.Resources>
    <Grid Background="#202225">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="72"/>
            <ColumnDefinition Width="240"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="240"/>
        </Grid.ColumnDefinitions>

        <!-- Community List (Left Sidebar) -->
        <controls:CommunityListView Grid.Column="0"
                                    Communities="{Binding Communities}"
                                    IsLoading="{Binding IsLoading}"
                                    SelectCommunityCommand="{Binding SelectCommunityCommand}"
                                    CreateCommunityCommand="{Binding CreateCommunityCommand}"
                                    OpenDMsCommand="{Binding OpenDMsCommand}"/>

        <!-- Channel List (Second Column) -->
        <Border Grid.Column="1" Background="#2f3136">
            <DockPanel>
                <!-- Community Name Header -->
                <Border DockPanel.Dock="Top" Background="#2f3136" Padding="16,12" BorderThickness="0,0,0,1" BorderBrush="#202225">
                    <TextBlock Text="{Binding SelectedCommunity.Name, FallbackValue='Select a Community'}"
                               Foreground="White"
                               FontWeight="SemiBold"
                               FontSize="16"/>
                </Border>

                <!-- User Panel at Bottom (always visible, docked first to be at very bottom) -->
                <controls:UserPanelView DockPanel.Dock="Bottom"
                                        Username="{Binding Username}"
                                        IsSpeaking="{Binding IsSpeaking}"
                                        IsMuted="{Binding IsMuted}"
                                        IsDeafened="{Binding IsDeafened}"
                                        ToggleMuteCommand="{Binding ToggleMuteCommand}"
                                        ToggleDeafenCommand="{Binding ToggleDeafenCommand}"
                                        OpenSettingsCommand="{Binding OpenSettingsCommand}"
                                        AudioDeviceButtonClicked="OnUserPanelAudioDeviceButtonClick"/>

                <!-- Voice Connected Panel (shows when in voice channel, above user panel) -->
                <controls:VoiceConnectedPanelView DockPanel.Dock="Bottom"
                                                  IsInVoiceChannel="{Binding IsInVoiceChannel}"
                                                  IsVoiceConnected="{Binding IsVoiceConnected}"
                                                  IsVoiceConnecting="{Binding IsVoiceConnecting}"
                                                  VoiceConnectionStatusText="{Binding VoiceConnectionStatusText}"
                                                  CurrentVoiceChannel="{Binding CurrentVoiceChannel}"
                                                  IsCameraOn="{Binding IsCameraOn}"
                                                  IsScreenSharing="{Binding IsScreenSharing}"
                                                  IsDrawingAllowedForViewers="{Binding IsDrawingAllowedForViewers, Mode=TwoWay}"
                                                  ToggleCameraCommand="{Binding ToggleCameraCommand}"
                                                  ToggleScreenShareCommand="{Binding ToggleScreenShareCommand}"
                                                  LeaveVoiceChannelCommand="{Binding LeaveVoiceChannelCommand}"/>

                <!-- Channel List -->
                <controls:ChannelListView Margin="8,8,0,0"
                                          TextChannels="{Binding TextChannels}"
                                          VoiceChannels="{Binding VoiceChannelViewModels}"
                                          CurrentVoiceChannel="{Binding CurrentVoiceChannel}"
                                          CanManageChannels="{Binding CanManageChannels}"
                                          CanManageVoice="{Binding CanManageVoice}"
                                          IsLoading="{Binding IsLoading}"
                                          EditingChannel="{Binding EditingChannel}"
                                          EditingChannelName="{Binding EditingChannelName, Mode=TwoWay}"
                                          CreateChannelCommand="{Binding CreateChannelCommand}"
                                          CreateVoiceChannelCommand="{Binding CreateVoiceChannelCommand}"
                                          SelectChannelCommand="{Binding SelectChannelCommand}"
                                          StartEditChannelCommand="{Binding StartEditChannelCommand}"
                                          SaveChannelNameCommand="{Binding SaveChannelNameCommand}"
                                          CancelEditChannelCommand="{Binding CancelEditChannelCommand}"
                                          DeleteChannelCommand="{Binding DeleteChannelCommand}"
                                          ConfirmDeleteChannelCommand="{Binding ConfirmDeleteChannelCommand}"
                                          CancelDeleteChannelCommand="{Binding CancelDeleteChannelCommand}"
                                          ChannelPendingDelete="{Binding ChannelPendingDelete}"
                                          ServerMuteUserCommand="{Binding ServerMuteUserCommand}"
                                          ServerDeafenUserCommand="{Binding ServerDeafenUserCommand}"
                                          ReorderChannelsCommand="{Binding ReorderChannelsCommand}"
                                          PreviewReorderCommand="{Binding PreviewReorderCommand}"
                                          CancelPreviewCommand="{Binding CancelPreviewCommand}"
                                          VoiceChannelClicked="OnVoiceChannelClicked"
                                          VoiceChannelViewRequested="OnVoiceChannelViewRequested"/>
            </DockPanel>
        </Border>

        <!-- Main Content Area (Chat, Voice Channel, or DM) -->
        <Grid Grid.Column="2">
            <!-- DM Content (shown when viewing DM conversation) -->
            <controls:DMContentView IsVisible="{Binding IsViewingDM}"
                                    ViewModel="{Binding DMContent}"/>

            <!-- Voice Channel Content (shown when viewing voice channel, but not DM) -->
            <controls:VoiceChannelContentView SelectedVoiceChannel="{Binding SelectedVoiceChannelForViewing}"
                                              ShowAudioDeviceWarning="{Binding ShowAudioDeviceWarning}"
                                              VoiceChannelContent="{Binding VoiceChannelContent}"
                                              OpenSettingsCommand="{Binding OpenSettingsCommand}"
                                              WatchScreenShareRequested="OnVoiceChannelWatchScreenShare"
                                              FullscreenRequested="OnVoiceChannelFullscreen"
                                              VideoTileDoubleTapped="OnVoiceChannelVideoTileDoubleTapped">
                <controls:VoiceChannelContentView.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                        <Binding Path="IsViewingVoiceChannel"/>
                        <Binding Path="IsViewingDM" Converter="{x:Static BoolConverters.Not}"/>
                    </MultiBinding>
                </controls:VoiceChannelContentView.IsVisible>
            </controls:VoiceChannelContentView>

            <!-- Chat Area (shown when not viewing voice channel or DM) -->
            <controls:ChatAreaView x:Name="ChatArea"
                                   ChannelName="{Binding SelectedChannel.Name}"
                                   ChannelTopic="{Binding SelectedChannel.Topic}"
                                   PinnedCount="{Binding PinnedCount}"
                                   IsReplying="{Binding IsReplying}"
                                   ReplyingToAuthor="{Binding ReplyingToMessage.AuthorUsername}"
                                   ReplyingToContent="{Binding ReplyingToMessage.Content}"
                                   IsAnyoneTyping="{Binding IsAnyoneTyping}"
                                   TypingIndicatorText="{Binding TypingIndicatorText}"
                                   HasPendingAttachments="{Binding HasPendingAttachments}"
                                   PendingAttachments="{Binding PendingAttachments}"
                                   IsMentionPopupOpen="{Binding IsMentionPopupOpen}"
                                   MentionSuggestions="{Binding MentionSuggestions}"
                                   SelectedMentionIndex="{Binding SelectedMentionIndex}"
                                   IsGifsEnabled="{Binding IsGifsEnabled}"
                                   MessageInput="{Binding MessageInput, Mode=TwoWay}"
                                   IsLoading="{Binding IsLoading}"
                                   Messages="{Binding Messages}"
                                   BaseUrl="{Binding BaseUrl}"
                                   IsEditing="{Binding EditingMessage, Converter={x:Static ObjectConverters.IsNotNull}}"
                                   EditingMessageContent="{Binding EditingMessageContent, Mode=TwoWay}"
                                   ShowPinnedMessagesCommand="{Binding ShowPinnedMessagesCommand}"
                                   CancelReplyCommand="{Binding CancelReplyCommand}"
                                   SendMessageCommand="{Binding SendMessageCommand}"
                                   TogglePinCommand="{Binding TogglePinCommand}"
                                   ReplyToMessageCommand="{Binding ReplyToMessageCommand}"
                                   StartEditMessageCommand="{Binding StartEditMessageCommand}"
                                   DeleteMessageCommand="{Binding DeleteMessageCommand}"
                                   CancelEditMessageCommand="{Binding CancelEditMessageCommand}"
                                   SaveMessageEditCommand="{Binding SaveMessageEditCommand}"
                                   AddReactionRequested="OnChatAreaAddReactionRequested"
                                   StartThreadRequested="OnChatAreaStartThreadRequested"
                                   ViewThreadRequested="OnChatAreaViewThreadRequested"
                                   ReactionToggleRequested="OnChatAreaReactionToggleRequested"
                                   ImageClicked="OnChatAreaImageClicked"
                                   MentionSelected="OnChatAreaMentionSelected"
                                   GifButtonClicked="OnChatAreaGifButtonClicked"
                                   AttachButtonClicked="OnChatAreaAttachButtonClicked"
                                   RemovePendingAttachmentRequested="OnChatAreaRemovePendingAttachment"
                                   FileDropped="OnChatAreaFileDropped"
                                   NavigateMentionUp="OnChatAreaNavigateMentionUp"
                                   NavigateMentionDown="OnChatAreaNavigateMentionDown"
                                   SelectCurrentMention="OnChatAreaSelectCurrentMention"
                                   CloseMentionPopup="OnChatAreaCloseMentionPopup">
                <controls:ChatAreaView.IsVisible>
                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                        <Binding Path="IsViewingVoiceChannel" Converter="{x:Static BoolConverters.Not}"/>
                        <Binding Path="IsViewingDM" Converter="{x:Static BoolConverters.Not}"/>
                    </MultiBinding>
                </controls:ChatAreaView.IsVisible>
            </controls:ChatAreaView>
        </Grid>

        <!-- Right Sidebar (Members List - always visible) -->
        <controls:MembersListView Grid.Column="3"
                                  ViewModel="{Binding MembersList}"
                                  MemberClicked="OnMemberClicked"/>

        <!-- Thread Panel Overlay (visible when thread IS open) -->
        <Border Grid.Column="2" Grid.ColumnSpan="2"
                HorizontalAlignment="Right"
                Width="{Binding ThreadPanelWidth}"
                IsVisible="{Binding CurrentThread, Converter={x:Static ObjectConverters.IsNotNull}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="4"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Resize Handle -->
                <Border Grid.Column="0"
                        Background="#202225"
                        Cursor="SizeWestEast"
                        PointerPressed="ThreadPanelResizeHandle_PointerPressed"
                        PointerMoved="ThreadPanelResizeHandle_PointerMoved"
                        PointerReleased="ThreadPanelResizeHandle_PointerReleased"/>

                <!-- Thread Content -->
                <controls:ThreadPanelView Grid.Column="1"
                                          DataContext="{Binding CurrentThread}"
                                          BaseUrl="{Binding $parent[UserControl].DataContext.BaseUrl}"
                                          StartEditMessageCommand="{Binding $parent[UserControl].DataContext.StartEditMessageCommand}"
                                          DeleteMessageCommand="{Binding $parent[UserControl].DataContext.DeleteMessageCommand}"
                                          AddReactionRequested="OnThreadMessageAddReactionRequested"
                                          ReactionToggleRequested="OnThreadMessageReactionToggleRequested"
                                          ImageClicked="OnAttachmentImageClicked"/>
            </Grid>
        </Border>

        <!-- Screen Share Picker Overlay -->
        <Border Grid.ColumnSpan="4"
                Background="#80000000"
                IsVisible="{Binding IsScreenSharePickerOpen}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <views:ScreenSharePickerView DataContext="{Binding ScreenSharePicker}"
                                          HorizontalAlignment="Center"
                                          VerticalAlignment="Center"/>
        </Border>

        <!-- Video Fullscreen Overlay -->
        <Border Grid.ColumnSpan="4"
                Background="#FF000000"
                IsVisible="{Binding IsVideoFullscreen}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <Grid>
                <!-- Video fills the space -->
                <Image x:Name="FullscreenVideoImage"
                       Source="{Binding FullscreenStream.VideoBitmap}"
                       Stretch="Uniform"
                       HorizontalAlignment="Stretch"
                       VerticalAlignment="Stretch"/>

                <!-- Drawing Canvas Overlay (transparent, captures drawing input when enabled) -->
                <Canvas x:Name="AnnotationCanvas"
                        Background="Transparent"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Stretch"
                        IsHitTestVisible="{Binding IsAnnotationEnabled}"
                        PointerPressed="OnAnnotationCanvasPointerPressed"
                        PointerMoved="OnAnnotationCanvasPointerMoved"
                        PointerReleased="OnAnnotationCanvasPointerReleased"/>

                <!-- Drawing Toolbar - bottom center (only visible when host allows drawing) -->
                <Border VerticalAlignment="Bottom"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,80"
                        Background="#E0202020"
                        CornerRadius="8"
                        Padding="12,8"
                        IsVisible="{Binding IsDrawingAllowedByHost}">
                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <!-- Draw mode toggle - only visible when host allows drawing -->
                        <ToggleButton IsChecked="{Binding IsAnnotationEnabled}"
                                      Padding="12,6"
                                      Background="#40FFFFFF"
                                      Foreground="White"
                                      CornerRadius="4">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="✏️" VerticalAlignment="Center"/>
                                <TextBlock Text="Draw" VerticalAlignment="Center"/>
                            </StackPanel>
                        </ToggleButton>

                        <!-- Color separator -->
                        <Border Width="1" Background="#40FFFFFF" Margin="4,0"/>

                        <!-- Color buttons -->
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <Button Width="28" Height="28" Padding="0" CornerRadius="4"
                                    Background="#FF0000" BorderThickness="2"
                                    BorderBrush="{Binding AnnotationColor, Converter={StaticResource ColorToBorderConverter}, ConverterParameter=#FF0000}"
                                    Click="OnAnnotationColorClick" Tag="#FF0000"/>
                            <Button Width="28" Height="28" Padding="0" CornerRadius="4"
                                    Background="#00FF00" BorderThickness="2"
                                    BorderBrush="{Binding AnnotationColor, Converter={StaticResource ColorToBorderConverter}, ConverterParameter=#00FF00}"
                                    Click="OnAnnotationColorClick" Tag="#00FF00"/>
                            <Button Width="28" Height="28" Padding="0" CornerRadius="4"
                                    Background="#0080FF" BorderThickness="2"
                                    BorderBrush="{Binding AnnotationColor, Converter={StaticResource ColorToBorderConverter}, ConverterParameter=#0080FF}"
                                    Click="OnAnnotationColorClick" Tag="#0080FF"/>
                            <Button Width="28" Height="28" Padding="0" CornerRadius="4"
                                    Background="#FFFF00" BorderThickness="2"
                                    BorderBrush="{Binding AnnotationColor, Converter={StaticResource ColorToBorderConverter}, ConverterParameter=#FFFF00}"
                                    Click="OnAnnotationColorClick" Tag="#FFFF00"/>
                            <Button Width="28" Height="28" Padding="0" CornerRadius="4"
                                    Background="#FFFFFF" BorderThickness="2"
                                    BorderBrush="{Binding AnnotationColor, Converter={StaticResource ColorToBorderConverter}, ConverterParameter=#FFFFFF}"
                                    Click="OnAnnotationColorClick" Tag="#FFFFFF"/>
                        </StackPanel>

                        <!-- Clear separator (only show when drawing allowed) -->
                        <Border Width="1" Background="#40FFFFFF" Margin="4,0"
                                IsVisible="{Binding IsDrawingAllowedByHost}"/>

                        <!-- Clear button (only show when drawing allowed) -->
                        <Button Padding="12,6"
                                Background="#40FFFFFF"
                                Foreground="White"
                                CornerRadius="4"
                                Click="OnClearAnnotationsClick"
                                IsVisible="{Binding IsDrawingAllowedByHost}">
                            <TextBlock Text="Clear"/>
                        </Button>
                    </StackPanel>
                </Border>

                <!-- Close button - top right -->
                <Button VerticalAlignment="Top"
                        HorizontalAlignment="Right"
                        Margin="16"
                        Padding="8,4"
                        Background="#60000000"
                        BorderThickness="0"
                        CornerRadius="4"
                        Cursor="Hand"
                        Click="OnCloseFullscreenClick">
                    <TextBlock Text="✕" Foreground="White" FontSize="20"/>
                </Button>

                <!-- Username label - bottom left -->
                <Border VerticalAlignment="Bottom"
                        HorizontalAlignment="Left"
                        Background="#80000000"
                        Padding="12,6"
                        Margin="16"
                        CornerRadius="4">
                    <TextBlock Text="{Binding FullscreenStream.Username}"
                               Foreground="White"
                               FontSize="14"/>
                </Border>
            </Grid>
        </Border>

        <!-- Nickname Edit Overlay -->
        <controls:NicknameEditOverlay Grid.ColumnSpan="4"
                                      IsVisibleOverlay="{Binding IsEditingNickname}"
                                      IsEditingMyNickname="{Binding IsEditingMyNickname}"
                                      EditingNickname="{Binding EditingNickname, Mode=TwoWay}"
                                      IsLoading="{Binding IsLoading}"
                                      SaveNicknameCommand="{Binding SaveNicknameCommand}"
                                      CancelNicknameEditCommand="{Binding CancelNicknameEditCommand}"/>

        <!-- Emoji Picker Popup -->
        <Popup x:Name="EmojiPickerPopup"
               IsLightDismissEnabled="True"
               Placement="Top"
               PlacementGravity="Top">
            <controls:EmojiPickerContent EmojiSelected="OnEmojiPickerEmojiSelected"/>
        </Popup>

        <!-- GIF Picker Popup -->
        <Popup x:Name="GifPickerPopup"
               IsLightDismissEnabled="True"
               Placement="Top"
               PlacementGravity="Top">
            <controls:GifPickerContent x:Name="GifPickerContent"
                                       GifSearchQuery="{Binding GifSearchQuery, Mode=TwoWay}"
                                       IsLoadingGifs="{Binding IsLoadingGifs}"
                                       GifResults="{Binding GifResults}"
                                       SearchGifsCommand="{Binding SearchGifsCommand}"
                                       GifSelected="OnGifPickerGifSelected"/>
        </Popup>

        <!-- Audio Device Popup -->
        <Popup x:Name="AudioDevicePopup"
               IsOpen="{Binding IsAudioDevicePopupOpen}"
               IsLightDismissEnabled="True"
               Placement="Bottom"
               PlacementTarget="{Binding $parent[Grid]}">
            <controls:AudioDeviceContent InputDevices="{Binding InputDevices}"
                                         SelectedInputDeviceItem="{Binding SelectedInputDeviceItem, Mode=TwoWay}"
                                         OutputDevices="{Binding OutputDevices}"
                                         SelectedOutputDeviceItem="{Binding SelectedOutputDeviceItem, Mode=TwoWay}"
                                         InputLevel="{Binding InputLevel}"
                                         PushToTalkEnabled="{Binding PushToTalkEnabled, Mode=TwoWay}"
                                         VoiceModeDescription="{Binding VoiceModeDescription}"
                                         RefreshDevicesRequested="OnAudioDeviceRefreshRequested"/>
        </Popup>

        <!-- Pinned Messages Popup -->
        <Popup IsOpen="{Binding IsPinnedPopupOpen}"
               IsLightDismissEnabled="True"
               Placement="Center"
               PlacementTarget="{Binding $parent[Grid]}">
            <controls:PinnedMessagesContent PinnedMessages="{Binding PinnedMessages}"
                                            ClosePinnedPopupCommand="{Binding ClosePinnedPopupCommand}"
                                            TogglePinCommand="{Binding TogglePinCommand}"/>
        </Popup>

        <!-- Quick Switcher Popup (Cmd+K / Ctrl+K) -->
        <Popup x:Name="QuickSwitcherPopup"
               IsLightDismissEnabled="True"
               Placement="Center"
               PlacementTarget="{Binding $parent[Grid]}">
            <controls:QuickSwitcherContent x:Name="QuickSwitcherContent"/>
        </Popup>

        <!-- Image Lightbox Overlay -->
        <controls:ImageLightbox Grid.ColumnSpan="4"
                                Attachment="{Binding LightboxImage}"
                                BaseUrl="{Binding BaseUrl}"
                                CloseRequested="OnLightboxCloseRequested"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"/>
    </Grid>
</UserControl>
